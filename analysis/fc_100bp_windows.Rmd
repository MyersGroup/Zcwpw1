---
title: "FC 100bp Windows"
output: html_notebook
---

# Load data

just using Chromosome 1, as many data points

```{r}
library(data.table)
library(ggplot2)
library(cowplot)

h3k4me3_UT_100bp <- fread("grep -P 'chr1\\t|chr\\t' peaks/ForceCalledPeaks_NA15-SRR5627150_vs_NA15-SRR5627142_AT_genome.windows.100wide.100slide.bed.bed")
h3k4me3_hP9_100bp <- fread("grep -P 'chr1\\t|chr\\t' peaks/ForceCalledPeaks_NA15-SRR5627152_AND_NA15-SRR5627153_vs_NA15-SRR5627143_AT_genome.windows.100wide.100slide.bed.bed")

h3k36me3_hP9_100bp <- fread("grep -P 'chr1\\t|chr\\t' peaks/ForceCalledPeaks_NA15-SRR5627149_vs_NA15-SRR5627143_AT_genome.windows.100wide.100slide.bed.bed")


zcw_100bp <- fread("grep -P 'chr1\\t|chr\\t' peaks/ForceCalledPeaks_WTCHG_538916_221156_vs_WTCHG_538916_217108_AND_WTCHG_538916_220144_AT_genome.windows.100wide.100slide.bed.bed")

zcw_hP9_100bp <- fread("grep -P 'chr1\\t|chr\\t' peaks/ForceCalledPeaks_WTCHG_538916_223180_vs_WTCHG_538916_217108_AND_WTCHG_538916_220144_AT_genome.windows.100wide.100slide.bed.bed")

zcw_cP9_100bp <- fread("grep -P 'chr1\\t|chr\\t' peaks/ForceCalledPeaks_WTCHG_538916_224192_vs_WTCHG_538916_217108_AND_WTCHG_538916_220144_AT_genome.windows.100wide.100slide.bed.bed")

zcw_hCVC <- fread("grep -P 'chr1\\t|chr\\t' peaks/ForceCalledPeaks_WTCHG_538916_223180_vs_WTCHG_538916_221156_AT_genome.windows.100wide.100slide.bed.bed")

zcw_cCVC <- fread("grep -P 'chr1\\t|chr\\t' peaks/ForceCalledPeaks_WTCHG_538916_224192_vs_WTCHG_538916_221156_AT_genome.windows.100wide.100slide.bed.bed")


hP9combo <- fread("grep -P 'chr1\\t|chr\\t' peaks/ForceCalledPeaks_NA15-SRR5627146_AND_NA15-SRR5627147_vs_NA15-SRR5627143_AT_genome.windows.100wide.100slide.bed.bed")

cP9combo <- fread("grep -P 'chr1\\t|chr\\t' peaks/ForceCalledPeaks_NA15-SRR5627145_AND_NA15-SRR5627144_vs_NA15-SRR5627143_AT_genome.windows.100wide.100slide.bed.bed")

forcecalled <- h3k4me3_UT_100bp
forcecalled$h3k4me3_UT <- forcecalled$enrichment
forcecalled$h3k4me3_UT_cov_input <- forcecalled$cov_input

forcecalled$h3k4me3_hP9_enrichment <- h3k4me3_hP9_100bp$enrichment

forcecalled$zcw_enrichment <- zcw_100bp$enrichment
forcecalled$zcw_pvalue <- zcw_100bp$pvalue
forcecalled$zcw_cov_input <- zcw_100bp$cov_input

forcecalled$zcw_hP9_enrichment <- zcw_hP9_100bp$enrichment
forcecalled$zcw_hP9_pvalue <- zcw_hP9_100bp$pvalue
#forcecalled$zcw_P9_cov_input <- zcw_hP9_100bp$cov_input # identical to zcw

forcecalled$zcw_cP9_enrichment <- zcw_cP9_100bp$enrichment
forcecalled$zcw_cP9_pvalue <- zcw_cP9_100bp$pvalue

forcecalled$zcw_hCVC_enrichment <- zcw_hCVC$enrichment
forcecalled$zcw_cCVC_enrichment <- zcw_cCVC$enrichment

forcecalled$hP9combo_enrichment <- hP9combo$enrichment
forcecalled$hP9combo_cov_input <- hP9combo$cov_input
forcecalled$hP9combo_pvalue <- hP9combo$pvalue


forcecalled$cP9combo_enrichment <- cP9combo$enrichment
forcecalled$cP9combo_cov_input <- cP9combo$cov_input
forcecalled$cP9combo_pvalue <- cP9combo$pvalue


forcecalled$h3k36me3_hP9_enrichment <- h3k36me3_hP9_100bp$enrichment
```


# Dependence of transfected Zcw on UT

```{r}
# plot(forcecalled$zcw_enrichment,forcecalled$zcw_hP9_enrichment, pch=".", log="xy")
# plot(forcecalled$zcw_enrichment,forcecalled$zcw_hP9_enrichment, pch=".")

# nb intercept doesn't move
fclm <- lm(zcw_hP9_enrichment ~ 1 + zcw_enrichment + hP9combo_enrichment, forcecalled[zcw_cov_input>5])
summary(fclm)

fclm <- lm(zcw_hP9_enrichment ~ 0 + zcw_enrichment + zcw_enrichment:hP9combo_enrichment, forcecalled[zcw_cov_input>5])
summary(fclm)

plot(fclm)

fclm2 <- lm(log(zcw_hP9_enrichment+0.1) ~ log(zcw_enrichment+0.1), forcecalled[zcw_cov_input>5])
plot(fclm2)

####
# Counts
####

# count hP9
cHP9 <- ggplot(forcecalled[zcw_cov_input>5], (aes(zcw_enrichment, zcw_hP9_enrichment))) +
  geom_hex(aes(fill = stat(log(count+0.1))), bins=200) +
  scale_fill_viridis_c(direction = -1) +
  theme(legend.position = "bottom")

  
# count cP9
cCP9 <- ggplot(forcecalled[zcw_cov_input>5], (aes(zcw_enrichment, zcw_cP9_enrichment))) +
  geom_hex(aes(fill = stat(log(count+0.1))), bins=200) +
  scale_fill_viridis_c(direction = -1) +
  theme(legend.position = "bottom")

####
# Color by P9 enrichment
####

# hP9 colour
p1 <- ggplot(forcecalled[zcw_cov_input>5], (aes(zcw_enrichment, zcw_hP9_enrichment, z=log(hP9combo_enrichment+0.1)))) +
  stat_summary_hex(bins=200) +
  scale_fill_viridis_c(name = "log(hP9+0.1)", direction = -1) +
  theme(legend.position = "bottom")

# cP9 colour
p2 <- ggplot(forcecalled[zcw_cov_input>5], (aes(zcw_enrichment, zcw_hP9_enrichment, z=log(cP9combo_enrichment+0.1)))) +
  stat_summary_hex(bins=200) +
  scale_fill_viridis_c(name = "log(cP9+0.1)", direction = -1) +
  theme(legend.position = "bottom")

# hP9 colour
p3 <- ggplot(forcecalled[zcw_cov_input>5], (aes(zcw_enrichment, zcw_cP9_enrichment, z=log(hP9combo_enrichment+0.1)))) +
  stat_summary_hex(bins=200) +
  scale_fill_viridis_c(name = "log(hP9+0.1)", direction = -1) +
  theme(legend.position = "bottom")

# cP9 colour
p4 <- ggplot(forcecalled[zcw_cov_input>5], (aes(zcw_enrichment, zcw_cP9_enrichment, z=log(cP9combo_enrichment+0.1)))) +
  stat_summary_hex(bins=200) +
  scale_fill_viridis_c(name = "log(cP9+0.1)", direction = -1) +
  theme(legend.position = "bottom")


####
# Color by CVC enrichment
####

p1CVC <- ggplot(forcecalled[zcw_cov_input>5], (aes(zcw_enrichment, zcw_hP9_enrichment, z=log(zcw_hCVC_enrichment+0.1)))) +
  stat_summary_hex(bins=200) +
  scale_fill_viridis_c(name = "log(hCVC+0.1)", direction = -1) +
  theme(legend.position = "bottom")

# cP9 colour
p2CVC <- ggplot(forcecalled[zcw_cov_input>5], (aes(zcw_enrichment, zcw_hP9_enrichment, z=log(zcw_cCVC_enrichment+0.1)))) +
  stat_summary_hex(bins=200) +
  scale_fill_viridis_c(name = "log(cCVC+0.1)", direction = -1) +
  theme(legend.position = "bottom")

# hP9 colour
p3CVC <- ggplot(forcecalled[zcw_cov_input>5], (aes(zcw_enrichment, zcw_cP9_enrichment, z=log(zcw_hCVC_enrichment+0.1)))) +
  stat_summary_hex(bins=200) +
  scale_fill_viridis_c(name = "log(hCVC+0.1)", direction = -1) +
  theme(legend.position = "bottom")

# cP9 colour
p4CVC <- ggplot(forcecalled[zcw_cov_input>5], (aes(zcw_enrichment, zcw_cP9_enrichment, z=log(zcw_cCVC_enrichment+0.1)))) +
  stat_summary_hex(bins=200) +
  scale_fill_viridis_c(name = "log(cCVC+0.1)", direction = -1) +
  theme(legend.position = "bottom")



# Arrange & Save plots

pdf(width = 14, height = 14, file = "Zcw_vs_CoTransfection.pdf")
plot_grid(cHP9 + ylim(0,8),
          cHP9 + scale_x_log10(limits=c(0.1,NA)) + scale_y_log10(limits=c(0.1,NA)),
          cCP9 + ylim(0,8),
          cCP9 + scale_x_log10(limits=c(0.1,NA)) + scale_y_log10(limits=c(0.1,NA))
          )

plot_grid(p1 + ylim(0,8), p2 + ylim(0,8), p3 + ylim(0,8), p4 + ylim(0,8))

plot_grid(p1 + scale_x_log10(limits=c(0.1,NA)) + scale_y_log10(limits=c(0.1,NA)),
          p2 + scale_x_log10(limits=c(0.1,NA)) + scale_y_log10(limits=c(0.1,NA)),
          p3 + scale_x_log10(limits=c(0.1,NA)) + scale_y_log10(limits=c(0.1,NA)),
          p4 + scale_x_log10(limits=c(0.1,NA)) + scale_y_log10(limits=c(0.1,NA)))

plot_grid(p1CVC + ylim(0,8), p2CVC + ylim(0,8), p3CVC + ylim(0,8), p4CVC + ylim(0,8))
dev.off()


# Split into definately bound and definately not, for visual clarity

pdf("Zcw_vs_CoTransfection2.pdf")
p1 + ylim(0,8) + gghighlight(hP9combo_pvalue<1e-9, unhighlighted_colour="darkgrey")
p1 + ylim(0,8) + gghighlight(hP9combo_pvalue==1, unhighlighted_colour="darkgrey")

cHP9 + ylim(0,8) + gghighlight(hP9combo_pvalue<1e-9, unhighlighted_colour="darkgrey")
cHP9 + ylim(0,8) + gghighlight(hP9combo_pvalue==1, unhighlighted_colour="darkgrey")

forcecalled[,hP9Combo.bound := NA]
forcecalled[hP9combo_pvalue==1,hP9Combo.bound := FALSE]
forcecalled[hP9combo_pvalue<1e-9,hP9Combo.bound := TRUE]

ggplot(forcecalled[zcw_cov_input>5 & hP9combo_cov_input>5], (aes(zcw_enrichment, zcw_hP9_enrichment, z=hP9Combo.bound))) +
  stat_summary_hex(bins=200, alpha=0.5, fun= function(x) as.character(mean(x))) + # na.rm=T
  #scale_fill_brewer(palette="Set1") +
  scale_fill_manual(labels = c("p = 1", "p < 10^(-9)"), values = c("#E41A1C", "#377EB8")) +
  labs(fill="Evidence of hPrdm9cterm binding") +
  theme(legend.position = "bottom") +
  ylim(0,8)
dev.off()

```


# Relative Strength/Attraction of H3K4me3

```{r}

# # K36 vs K4wP9
# 
# plot(forcecalled$h3k36me3_hP9_enrichment, forcecalled$h3k4me3_hP9_enrichment, pch=".", col='#00000010')
# points(forcecalled[zcw_hP9_enrichment>1 & zcw_P9_pvalue<1e-6]$h3k36me3_hP9_enrichment,
#        forcecalled[zcw_hP9_enrichment>1 & zcw_P9_pvalue<1e-6]$h3k4me3_hP9_enrichment, pch=".", col='#FF000010')

# # K4UT vs P9
# 
# qplot(forcecalled$h3k4me3_UT, forcecalled$P9_enrichment, stroke=I(0), alpha=I(0.1), col=forcecalled$zcw_enrichment>1)
# 
# plot(forcecalled[zcw_hP9_enrichment<1]$h3k4me3_UT, forcecalled[zcw_hP9_enrichment<1]$P9_enrichment, pch=".", col='#00000005')
# points(forcecalled[zcw_hP9_enrichment>1 & zcw_P9_pvalue<1e-6]$h3k4me3_UT, forcecalled[zcw_hP9_enrichment>1 & zcw_P9_pvalue<1e-6]$P9_enrichment, pch=".", col='#FF000005')
# 
# # K4UT vs P9 for Zcw_enrichment < vs > 1
# plot(forcecalled[zcw_enrichment<1]$h3k4me3_UT+0.01, forcecalled[zcw_enrichment<1]$P9_enrichment+0.01, pch=".", col='#00000010')
# points(forcecalled[zcw_enrichment>1 & zcw_pvalue<1e-6]$h3k4me3_UT+0.01, forcecalled[zcw_enrichment>1 & zcw_pvalue<1e-6]$P9_enrichment+0.01, pch=".", col='#FF000010')
# 
# # Log version
# plot(forcecalled[zcw_enrichment<1]$h3k4me3_UT+0.01, forcecalled[zcw_enrichment<1]$P9_enrichment+0.01, pch=".", col='#00000010', log="xy")
# points(forcecalled[zcw_enrichment>1 & zcw_pvalue<1e-6]$h3k4me3_UT+0.01, forcecalled[zcw_enrichment>1 & zcw_pvalue<1e-6]$P9_enrichment+0.01, pch=".", col='#FF000010')


pdf("H3K4strength.pdf")

# K4UT vs K4wP9

p <- ggplot(forcecalled[h3k4me3_UT>5], aes(h3k4me3_UT, h3k4me3_hP9_enrichment)) +
  geom_hex(aes(fill = stat(log(count))), bins=200) +
  scale_fill_viridis_c() + xlim(0,100) + ylim(0,50)

p + facet_wrap(~ zcw_P9_pvalue<1e-6 ) + ggtitle("Split by zcw_P9_pvalue<1e-6")


# K36wP9 vs K4wP9

p <- ggplot(forcecalled[h3k36me3_hP9_enrichment>5], aes(h3k36me3_hP9_enrichment, h3k4me3_hP9_enrichment)) +
  geom_hex(aes(fill = stat(log(count))), bins=200) +
  scale_fill_viridis_c()

p + facet_wrap(~ zcw_P9_pvalue<1e-6 ) + ggtitle("Split by zcw_P9_pvalue<1e-6")


# K4UT vs Zcw
ggplot(forcecalled[h3k4me3_UT>5], aes(h3k4me3_UT, zcw_enrichment)) +
  geom_hex(aes(fill = stat(log(count))), bins=200) +
  scale_fill_viridis_c() + 
  ylim(0,10) + xlim(0,100)

# K4UT vs Zcw w/ hP9
ggplot(forcecalled[h3k4me3_UT>5], aes(h3k4me3_UT, zcw_hP9_enrichment)) +
  geom_hex(aes(fill = stat(log(count))), bins=200) +
  scale_fill_viridis_c() + 
  ylim(0,10) + xlim(0,100)

# K4UT vs P9
p <- ggplot(forcecalled[h3k4me3_UT>5], aes(h3k4me3_UT, hP9combo_enrichment)) +
  geom_hex(aes(fill = stat(log(count))), bins=200) +
  scale_fill_viridis_c() + xlim(0,100)

p + facet_wrap(~ zcw_P9_pvalue<1e-6 ) + ggtitle("Split by zcw_P9_pvalue<1e-6") + 
  ylim(0,15)

p + facet_wrap(~ zcw_enrichment>1 ) + ggtitle("Split by zcw_enrichment>1") + 
  ylim(0,15)

dev.off()

```

