---
title: "Bayesian Peak Calling"
output: html_notebook
---

```{r}
library(rstan)
Peak_model <- '
data {
real alpha1; // 
real alpha2; // 
real beta; // 
int Y;
int Z;
int B;
}

parameters {
real b;
real c;
}

model {
Y ~ poisson(alpha1*b + c);
Z ~ poisson(alpha2*b + beta*c);
B ~ poisson(b);
}

generated quantities{
  real y;
  y = c/b;
}
'

Peak_modelR <- '
data {
real alpha1; // 
real alpha2; // 
real beta; // 
real gamb;
real gamc;
int Y;
int Z;
int B;
}

parameters {
real<lower=0> b;
real<lower=0> c;
}

model {
b ~ gamma(gamb,1);
c ~ gamma(gamc,1);

Y ~ poisson(alpha1*b + c);
Z ~ poisson(alpha2*b + beta*c);
B ~ poisson(b);

}

generated quantities{
  real y;
  y = c/b;
}
'

datai=list("Y"=13,
           "Z"=25,
           "B"=6,
           "gamb"=1,
           "gamc"=1,
           "alpha1"=0.702681950312508,
           "alpha2"=0.590384282875748,
           "beta"=1.78748647265506)

datai=list("Y"=11,
           "Z"=22,
           "B"=0,
           "gamb"=1,
           "gamc"=1,
           "alpha1"=0.702681950312508,
           "alpha2"=0.590384282875748,
           "beta"=1.78748647265506)

datai=list("Y"=39,
           "Z"=41,
           "B"=19,
           "gamb"=1,
           "gamc"=1,
           "alpha1"=0.702681950312508,
           "alpha2"=0.590384282875748,
           "beta"=1.78748647265506)

datai=list("Y"=19,
           "Z"=44,
           "B"=3,
           "gamb"=1,
           "gamc"=1,
           "alpha1"=0.702681950312508,
           "alpha2"=0.590384282875748,
           "beta"=1.78748647265506)

datai=list("Y"=65,
           "Z"=124,
           "B"=0,
           "gamb"=1,
           "gamc"=1,
           "alpha1"=0.702681950312508,
           "alpha2"=0.590384282875748,
           "beta"=1.78748647265506)
               
fit <- stan(model_code = Peak_model, data = datai, iter = 10000, chains = 3)
fitR <- stan(model_code = Peak_modelR, data = datai, iter = 10000, chains = 3)

fit
fitR

plot(density(log(c(as.array(fit)[,,"y"]))), ylim=c(0,0.5))
lines(density(log(c(as.array(fitR)[,,"y"]))), col='red')


datai=list("Y"=65,
           "Z"=124,
           "B"=0,
           "gamb"=1,
           "gamc"=1,
           "alpha1"=0.702681950312508,
           "alpha2"=0.590384282875748,
           "beta"=1.78748647265506)

# hP9_AT_hP9N
#ForceCalledPeaks_SRA_Altemose2015_SRR5627146_vs_SRA_Altemose2015_SRR5627143_AT_SRA_Altemose2015_SRR5627138_AND_SRR5627139_vs_SRA_Altemose2015_SRR5627140.bed
#0.283252, 0.283131, 0.9986
#10     10         4  2.2182650  22.653348 1.940219e-06
# 5      2         6  0.3004554   1.683321 1.944838e-01
#27     28        10  2.4684144  65.060459 7.263503e-16
#10      3        14  0.1813434   1.623650 2.025836e-01

datai=list("Y"=5,
           "Z"=2,
           "B"=6,
           "gamb"=1,
           "gamc"=1,
           "alpha1"=0.283252,
           "alpha2"=0.283131,
           "beta"=0.9986)

fit <- stan(model_code = Peak_model, data = datai, iter = 10000, chains = 3)
fitR <- stan(model_code = Peak_modelR, data = datai, iter = 10000, chains = 3)

fit
fitR

plot(density(log(c(as.array(fit)[,,"y"]))), ylim=c(0,0.5))
lines(density(log(c(as.array(fitR)[,,"y"]))), col='red')

plot(density(log(c(as.array(fit)[,,"y"]))), ylim=c(0,0.5))
lines(density(log(c(as.array(fitR)[,,"y"]))), col='red')

# 13     25         6   1.944459   24.21961 8.595257e-07
 #11     22         0  23.931664
  #39     41        19   0.921903
  #44     95        21   2.115073
    #19     44         3   7.616374
#65    124         0 137.3213395

posterior2 <- as.array(fit)
bayesplot::mcmc_areas(as.array(fit), pars = c("b","c","y"))
bayesplot::mcmc_areas(as.array(fitR), pars = c("b","c","y"))
bayesplot::mcmc_pairs(posterior2, pars = c("b","c","y"))
bayesplot::mcmc_trace(posterior2, pars = c("b","c","y"))
```


