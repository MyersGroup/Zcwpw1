---
title: "ForceCalling at C and N term Prdm9 peaks"
output: 
  html_notebook: 
    code_folding: show
    fig_height: 6
    fig_width: 10.5
    results: hold
    fig_show: hold
    toc: yes
    toc_float: yes
    number_sections: yes
    theme: spacelab
---


```{r}
knitr::opts_knit$set(base.dir = "results")
knitr::opts_chunk$set(fig.path = "ForceCallingHP9/")
knitr::opts_chunk$set(dev="pdf")
knitr::opts_chunk$set(fig.show="hold")

library(ggplot2)
library(data.table)
library(cowplot)
library(PRROC)
library(brms)

source("../functions.R")
```

# Load Results

```{r load_non_force_called}
HP9_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627146_vs_NA15-SRR5627143.p0.000001.sep250.ALL.bed")
HP9combo_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627146_AND_NA15-SRR5627147_vs_NA15-SRR5627143.p0.000001.sep250.ALL.bed")
HP9N_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627138_AND_NA15-SRR5627139_vs_NA15-SRR5627140.p0.000001.sep250.ALL.bed")
zcw_wP9_vs_chip_Z <- fread("../data/peaks/SingleBasePeaks.WTCHG_538916_223180_vs_WTCHG_538916_221156.p0.000001.sep250.ALL.bed")

HP9_peaks <- prejoin(HP9_peaks)
HP9N_peaks <- prejoin(HP9N_peaks)
HP9combo_peaks <- prejoin(HP9combo_peaks)
zcw_wP9_vs_chip_Z <- prejoin(zcw_wP9_vs_chip_Z)
```


## C term

```{r}
h3k4me3_UT_AT_HP9 <- fread("../data/peaks/ForceCalledPeaks_NA15-SRR5627150_vs_NA15-SRR5627142_AT_NA15-SRR5627146_vs_NA15-SRR5627143.bed")
setkey(h3k4me3_UT_AT_HP9, chr, center_start, center_stop)

h3k4me3_P9_AT_HP9 <- fread("../data/peaks/ForceCalledPeaks_NA15-SRR5627152_AND_SRR5627153_vs_NA15-SRR5627143_AT_NA15-SRR5627146_vs_NA15-SRR5627143.bed")
setkey(h3k4me3_P9_AT_HP9, chr, center_start, center_stop)

h3k36me3_P9_AT_HP9 <- fread("../data/peaks/ForceCalledPeaks_NA15-SRR5627149_vs_NA15-SRR5627143_AT_NA15-SRR5627146_vs_NA15-SRR5627143.bed")
setkey(h3k36me3_P9_AT_HP9, chr, center_start, center_stop)

Zcw_CVC_AT_hP9 <- fread("../data/peaks/ForceCalledPeaks_WTCHG_538916_223180_vs_WTCHG_538916_221156_AT_NA15-SRR5627146_vs_NA15-SRR5627143.bed")
setkey(Zcw_CVC_AT_hP9, chr, center_start, center_stop)

HP9_peaks$FC_Zcw_CVC_enrichment <- Zcw_CVC_AT_hP9$enrichment
HP9_peaks$FC_h3k4me3_P9_enrichment <- h3k4me3_P9_AT_HP9$enrichment
HP9_peaks$FC_h3k4me3_UT_enrichment <- h3k4me3_UT_AT_HP9$enrichment
HP9_peaks$FC_h3k36me3_P9_enrichment <- h3k36me3_P9_AT_HP9$enrichment


HP9_peaks$FC_Zcw_CVC_pvalue <- Zcw_CVC_AT_hP9$pvalue
HP9_peaks$FC_h3k4me3_P9_pvalue <- h3k4me3_P9_AT_HP9$pvalue
HP9_peaks$FC_h3k4me3_UT_pvalue <- h3k4me3_UT_AT_HP9$pvalue
HP9_peaks$FC_h3k36me3_P9_pvalue <- h3k36me3_P9_AT_HP9$pvalue

HP9_peaks$FC_Zcw_CVC_cov_input <- Zcw_CVC_AT_hP9$cov_input
```

## C term combo

```{r}
h3k4me3_UT_AT_HP9combo <- fread("../data/peaks/ForceCalledPeaks_NA15-SRR5627150_vs_NA15-SRR5627142_AT_NA15-SRR5627146_AND_NA15-SRR5627147_vs_NA15-SRR5627143.bed")
setkey(h3k4me3_UT_AT_HP9combo, chr, center_start, center_stop)

h3k4me3_P9_AT_HP9combo <- fread("../data/peaks/ForceCalledPeaks_NA15-SRR5627152_AND_NA15-SRR5627153_vs_NA15-SRR5627143_AT_NA15-SRR5627146_AND_NA15-SRR5627147_vs_NA15-SRR5627143.bed")
setkey(h3k4me3_P9_AT_HP9combo, chr, center_start, center_stop)

h3k36me3_P9_AT_HP9combo <- fread("../data/peaks/ForceCalledPeaks_NA15-SRR5627149_vs_NA15-SRR5627143_AT_NA15-SRR5627146_AND_NA15-SRR5627147_vs_NA15-SRR5627143.bed")
setkey(h3k36me3_P9_AT_HP9combo, chr, center_start, center_stop)

Zcw_CVC_AT_hP9combo <- fread("../data/peaks/ForceCalledPeaks_WTCHG_538916_223180_vs_WTCHG_538916_221156_AT_NA15-SRR5627146_AND_NA15-SRR5627147_vs_NA15-SRR5627143.bed")
setkey(Zcw_CVC_AT_hP9combo, chr, center_start, center_stop)


Zcw_wP9_AT_hP9combo <- fread("../data/peaks/ForceCalledPeaks_WTCHG_538916_223180_vs_WTCHG_538916_220144_AT_NA15-SRR5627146_AND_NA15-SRR5627147_vs_NA15-SRR5627143.bed")
setkey(Zcw_wP9_AT_hP9combo, chr, center_start, center_stop)

Zcw_AT_hP9combo <- fread("../data/peaks/ForceCalledPeaks_WTCHG_538916_221156_vs_WTCHG_538916_217108_AT_NA15-SRR5627146_AND_NA15-SRR5627147_vs_NA15-SRR5627143.bed")
setkey(Zcw_AT_hP9combo, chr, center_start, center_stop)

HP9combo_peaks$FC_Zcw_CVC_enrichment <- Zcw_CVC_AT_hP9combo$enrichment
HP9combo_peaks$FC_Zcw_wP9_enrichment <- Zcw_wP9_AT_hP9combo$enrichment
HP9combo_peaks$FC_Zcw_enrichment <- Zcw_AT_hP9combo$enrichment

HP9combo_peaks$FC_h3k4me3_P9_enrichment <- h3k4me3_P9_AT_HP9combo$enrichment
HP9combo_peaks$FC_h3k4me3_UT_enrichment <- h3k4me3_UT_AT_HP9combo$enrichment
HP9combo_peaks$FC_h3k36me3_P9_enrichment <- h3k36me3_P9_AT_HP9combo$enrichment


HP9combo_peaks$FC_Zcw_CVC_pvalue <- Zcw_CVC_AT_hP9combo$pvalue

HP9combo_peaks$FC_Zcw_CVC_cov_input <- Zcw_CVC_AT_hP9combo$cov_input
HP9combo_peaks$FC_Zcw_wP9_cov_input <- Zcw_wP9_AT_hP9combo$cov_input
HP9combo_peaks$FC_h3k4me3_P9_cov_input <- h3k4me3_P9_AT_HP9combo$cov_input
HP9combo_peaks$FC_h3k4me3_UT_cov_input <- h3k4me3_UT_AT_HP9combo$cov_input
HP9combo_peaks$FC_h3k36me3_P9_cov_input <- h3k36me3_P9_AT_HP9combo$cov_input


all.equal(Zcw_CVC_AT_hP9combo$center_start, HP9combo_peaks$center_start)
```


## N term

```{r}
h3k4me3_UT_AT_HP9N <- fread("../data/peaks/ForceCalledPeaks_NA15-SRR5627150_vs_NA15-SRR5627142_AT_NA15-SRR5627138_AND_SRR5627139_vs_NA15-SRR5627140.bed")
setkey(h3k4me3_UT_AT_HP9N, chr, center_start, center_stop)

h3k4me3_P9_AT_HP9N <- fread("../data/peaks/ForceCalledPeaks_NA15-SRR5627152_AND_NA15-SRR5627153_vs_NA15-SRR5627143_AT_NA15-SRR5627138_AND_SRR5627139_vs_NA15-SRR5627140.bed")
setkey(h3k4me3_P9_AT_HP9N, chr, center_start, center_stop)

h3k36me3_P9_AT_HP9N <- fread("../data/peaks/ForceCalledPeaks_NA15-SRR5627149_vs_NA15-SRR5627143_AT_NA15-SRR5627138_AND_SRR5627139_vs_NA15-SRR5627140.bed")
setkey(h3k36me3_P9_AT_HP9N, chr, center_start, center_stop)

Zcw_CVC_AT_hP9N <- fread("../data/peaks/ForceCalledPeaks_WTCHG_538916_223180_vs_WTCHG_538916_221156_AT_NA15-SRR5627138_AND_SRR5627139_vs_NA15-SRR5627140.bed")
setkey(Zcw_CVC_AT_hP9N, chr, center_start, center_stop)

Zcw_CVC_AT_hP9N_flank150 <- fread("../data/peaks/ForceCalledPeaks_WTCHG_538916_223180_vs_WTCHG_538916_221156_AT_NA15-SRR5627138_AND_NA15-SRR5627139_vs_NA15-SRR5627140.flank150.bed")
setkey(Zcw_CVC_AT_hP9N_flank150, chr, center_start, center_stop)

Zcw_wP9_AT_hP9N <- fread("../data/peaks/ForceCalledPeaks_WTCHG_538916_223180_vs_WTCHG_538916_220144_AT_NA15-SRR5627138_AND_SRR5627139_vs_NA15-SRR5627140.bed")
setkey(Zcw_wP9_AT_hP9N, chr, center_start, center_stop)

Zcw_AT_hP9N <- fread("../data/peaks/ForceCalledPeaks_WTCHG_538916_221156_vs_WTCHG_538916_217108_AT_NA15-SRR5627138_AND_SRR5627139_vs_NA15-SRR5627140.bed")
setkey(Zcw_AT_hP9N, chr, center_start, center_stop)

hP9_AT_hP9N <- fread("../data/peaks/ForceCalledPeaks_NA15-SRR5627146_vs_NA15-SRR5627143_AT_NA15-SRR5627138_AND_SRR5627139_vs_NA15-SRR5627140.bed")
setkey(hP9_AT_hP9N, chr, center_start, center_stop)

hP9combo_AT_hP9N <- fread("../data/peaks/ForceCalledPeaks_NA15-SRR5627146_AND_NA15-SRR5627147_vs_NA15-SRR5627143_AT_NA15-SRR5627138_AND_SRR5627139_vs_NA15-SRR5627140.bed")
setkey(hP9combo_AT_hP9N, chr, center_start, center_stop)


HP9N_peaks$FC_Zcw_CVC_enrichment <- Zcw_CVC_AT_hP9N$enrichment
HP9N_peaks$FC_Zcw_CVC_enrichment_flank150 <- Zcw_CVC_AT_hP9N_flank150$enrichment
HP9N_peaks$FC_Zcw_wP9_enrichment <- Zcw_wP9_AT_hP9N$enrichment
HP9N_peaks$FC_Zcw_enrichment <- Zcw_AT_hP9N$enrichment
HP9N_peaks$FC_h3k4me3_P9_enrichment <- h3k4me3_P9_AT_HP9N$enrichment
HP9N_peaks$FC_h3k4me3_UT_enrichment <- h3k4me3_UT_AT_HP9N$enrichment
HP9N_peaks$FC_h3k36me3_P9_enrichment <- h3k36me3_P9_AT_HP9N$enrichment
HP9N_peaks$FC_hP9_enrichment <- hP9_AT_hP9N$enrichment
HP9N_peaks$FC_hP9combo_enrichment <- hP9combo_AT_hP9N$enrichment

HP9N_peaks$FC_Zcw_CVC_pvalue <- Zcw_CVC_AT_hP9N$pvalue
HP9N_peaks$FC_hP9_pvalue <- hP9_AT_hP9N$pvalue
HP9N_peaks$FC_hP9combo_pvalue <- hP9combo_AT_hP9N$pvalue

HP9N_peaks$FC_Zcw_CVC_cov_input <- Zcw_CVC_AT_hP9N$cov_input
HP9N_peaks$FC_Zcw_CVC_cov_input_flank150 <- Zcw_CVC_AT_hP9N_flank150$cov_input
HP9N_peaks$FC_Zcw_wP9_cov_input <- Zcw_wP9_AT_hP9N$cov_input
HP9N_peaks$FC_Zcw_cov_input <- Zcw_AT_hP9N$cov_input
HP9N_peaks$FC_h3k4me3_P9_cov_input <- h3k4me3_P9_AT_HP9N$cov_input
HP9N_peaks$FC_h3k4me3_UT_cov_input <- h3k4me3_UT_AT_HP9N$cov_input
HP9N_peaks$FC_h3k36me3_P9_cov_input <- h3k36me3_P9_AT_HP9N$cov_input

```

```{r}
dmc1 <- fread("../data/pratto_dmc1/Pratto_human_DSB_Aintersect_autosomal_hg38.bed")
setnames(dmc1, c("chr","CI_start","CI_stop","enrichment","enrichmentAB"))
dmc1 <- prejoin(dmc1, 0)
dmc1 <- trim_peaks(dmc1, 800)
```


```{r}
fraction_overlap_FC_pthresh <- function(dt,x,y,n=100){
  setorder(dt, enrichment)
  binning_vector <- cut(1:nrow(dt), n)
    plot(1:n/n, tapply(dt[,get(y)]<1e-6, binning_vector, mean),
         xlab=paste("Fraction of",x,"Peaks (ordered low to high enrichment)"),
         ylab=paste("Fraction of",y,"ForceCalled peaks with pvalue<1e-6"))  
}

fraction_overlap_FC_mean <- function(dt,x,y,n=100){
  setorder(dt, enrichment)
  binning_vector <- cut(1:nrow(dt), n)
    plot(1:n/n, tapply(dt[,get(y)], binning_vector, mean),
         xlab=paste("Fraction of",x,"Peaks  (ordered low to high enrichment)"),
         ylab=paste("Mean Enrichment of ",y,"ForceCalled peaks"))  
}
```

# Sanity Checking

(previous issue was due to inconsitent ordering of chromosomes numerically vs alphabetically)

```{r}
#check ordering
mean(Zcw_CVC_AT_hP9$center_start == HP9_peaks$center_start)
mean(Zcw_CVC_AT_hP9N$center_start == HP9N_peaks$center_start)
unique(Zcw_CVC_AT_hP9$chr)
unique(HP9_peaks$chr)

# check for Zcw offset vs P9
HP9_peaks$zcw_CVC_center_start <- foverlaps(HP9_peaks, zcw_wP9_vs_chip_Z, mult="first")$center_start
hist(HP9_peaks[cov_input>5,.(center_start-zcw_CVC_center_start)]$V1, breaks=400); abline(v=0, col='red')

# check NormalCall vs ForceCall pvalue corr
zcw_wP9_vs_chip_Z$FC_Zcw_CVC_pvalue <- foverlaps(zcw_wP9_vs_chip_Z, Zcw_CVC_AT_hP9, mult="first")$pvalue
plot(-log10(zcw_wP9_vs_chip_Z$pvalue), -log10(zcw_wP9_vs_chip_Z$FC_Zcw_CVC_pvalue), xlim=c(0,50), ylim=c(0,40), pch="."); abline(0,1, col='red')

mean(Zcw_CVC_AT_hP9$pvalue[HP9_peaks$enrichment<1 & HP9_peaks$cov_input>=5]<=1e-6)
mean(Zcw_CVC_AT_hP9$pvalue[HP9_peaks$enrichment>1 & HP9_peaks$cov_input>=5]<=1e-6)
mean(Zcw_CVC_AT_hP9$pvalue[HP9_peaks$enrichment>3 & HP9_peaks$cov_input>=5]<=1e-6)
mean(Zcw_CVC_AT_hP9$pvalue[HP9_peaks$enrichment>4 & HP9_peaks$cov_input>=5]<=1e-6)
mean(Zcw_CVC_AT_hP9$pvalue[HP9_peaks$enrichment>10 & HP9_peaks$cov_input>=5]<=1e-6)
```

# PRDM9_ZCWPW1_Correlation

```{r, PRDM9_ZCWPW1_Correlation}
i=10
ii=3

a <- HP9combo_peaks[cov_input>i & FC_Zcw_wP9_cov_input>ii]$enrichment
b <- HP9combo_peaks[cov_input>i & FC_Zcw_wP9_cov_input>ii]$FC_Zcw_wP9_enrichment
c <- HP9combo_peaks[cov_input>i & FC_Zcw_wP9_cov_input>ii]$FC_Zcw_CVC_enrichment

k=11
outliers <- c(
which(a >= min(-head(sort(-a), k))),
which(b >= min(-head(sort(-b), k))),
which(c >= min(-head(sort(-c), k)))
)

cor.test(a[-outliers], c[-outliers])
summary(lm(log(c[-outliers]+0.1) ~ log(a[-outliers]+0.1)))

qplot(a[-outliers]+0.1, c[-outliers]+0.1, size=I(0.3), alpha=I(0.15)) + 
  scale_x_log10() + scale_y_log10() + 
  ylab("ZCWPW1 Enrichment (with PRDM9 vs without)") + xlab("PRDM9 Enrichment (vs input)") + 
  geom_smooth(method="lm", se=F, colour="red", linetype="dashed") + geom_smooth()

cor.test(a[-outliers], b[-outliers])
qplot(a[-outliers]+0.1, b[-outliers]+1, size=I(0.1), alpha=I(0.3)) + geom_smooth() + scale_x_log10() + scale_y_log10() + ylab("ZCWPW1 Enrichment (with PRDM9 vs input)") + xlab("PRDM9 Enrichment (vs input)")

```


# HP9 N vs HP9

```{r}
cor(HP9N_peaks$enrichment, HP9N_peaks$FC_hP9combo_enrichment)
cor(HP9N_peaks$enrichment, HP9N_peaks$FC_hP9combo_enrichment, method = "spearman")
plot(HP9N_peaks$enrichment, HP9N_peaks$FC_hP9combo_enrichment, log='xy', pch='.')

fraction_overlap_FC_pthresh(HP9N_peaks[cov_input>8],"HP9N", "FC_hP9combo_pvalue")
fraction_overlap_FC_mean(HP9N_peaks[cov_input>8],"HP9N", "FC_hP9combo_enrichment")
```


# HP9N GLMs

'enrichment' = hPrdm9 Nterm enrichment vs input
Largest parameter is Zcw_CVC
exp(1.90)=6.69

```{r}
HP9N_peaks$DMC1_enrichment <- foverlaps(HP9N_peaks, dmc1, mult="first")$enrichment

HP9N_peaks$isDMC1 <- !is.na(HP9N_peaks$DMC1_enrichment)

DMC1N_glm <- glm(isDMC1 ~ enrichment + 
        FC_Zcw_CVC_enrichment + 
        FC_h3k4me3_P9_enrichment+ 
        FC_h3k4me3_UT_enrichment + 
        FC_h3k36me3_P9_enrichment + 
        enrichment:FC_Zcw_CVC_enrichment,
    family=binomial(link='logit'),
    data=HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"])

summary(DMC1N_glm)
```

## Simplified/Alt Models

```{r}
DMC1N_glmNOZCW <- glm(isDMC1 ~ enrichment + 
        FC_h3k4me3_P9_enrichment+ 
        FC_h3k4me3_UT_enrichment + 
        FC_h3k36me3_P9_enrichment,
    family=binomial(link='logit'),
    data=HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"])

summary(DMC1N_glmNOZCW)

DMC1N_glmNOP9 <- glm(isDMC1 ~
        FC_Zcw_CVC_enrichment + 
        FC_h3k4me3_P9_enrichment+ 
        FC_h3k4me3_UT_enrichment + 
        FC_h3k36me3_P9_enrichment,
    family=binomial(link='logit'),
    data=HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"])

summary(DMC1N_glmNOP9)

HP9N_peaks[, FC_Zcw_ratio := FC_Zcw_wP9_enrichment-FC_Zcw_enrichment]

DMC1N_glmZcw_wP9 <- glm(isDMC1 ~
        FC_Zcw_enrichment +
        FC_Zcw_wP9_enrichment + 
        FC_h3k4me3_P9_enrichment+ 
        FC_h3k4me3_UT_enrichment + 
        FC_h3k36me3_P9_enrichment + 
        FC_Zcw_enrichment:FC_Zcw_wP9_enrichment,
    family=binomial(link='logit'),
    data=HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"])

summary(DMC1N_glmZcw_wP9)
```

## Pediction Evaluation (on training...)
Black = Full model

Green = Without hPrdm9 N term

Blue = Without Zcw_CVC

Without Zcw_CVC seems to do better despite having a larger coefficient...?

```{r}

probs = predict(DMC1N_glm,
                newdata = HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"],
                type = "response")
dmc1label = HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"]$isDMC1

probsNOZCW = predict(DMC1N_glmNOZCW,
  newdata=HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"], type="response")

probsNOP9 = predict(DMC1N_glmNOP9,
  newdata=HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"], type="response")

# probsZcw_wP9 = predict(DMC1N_glmZcw_wP9,
#   newdata=HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"], type="response")

caret::confusionMatrix(data = as.factor(probs>0.5),
                reference = as.factor(dmc1label), positive = "TRUE")

# ROC Curve
tmpNOZCW <- roc.curve(scores.class0 = probsNOZCW, weights.class0 = dmc1label, curve = T)$curve
tmpNOP9 <- roc.curve(scores.class0 = probsNOP9, weights.class0 = dmc1label, curve = T)$curve
# tmpZcw_wP9 <- roc.curve(scores.class0 = probsZcw_wP9, weights.class0 = dmc1label, curve = T)$curve
tmp <- roc.curve(scores.class0 = probs, weights.class0 = dmc1label, curve = T)$curve

plot(tmp, type='l', ylim=c(0,1), ylab='Sensitivity (TPR, Recall)', xlab='1-Specificity (1-FPR)', main='ROC') + abline(0,1, col='red')
lines(tmpNOP9, col='green')
lines(tmpNOZCW, col='blue')
# lines(tmpZcw_wP9, col='purple')

# PR Curve
tmpNOZCW <- pr.curve(scores.class0 = probsNOZCW, weights.class0 = dmc1label, curve = T)$curve
tmpNOP9 <- pr.curve(scores.class0 = probsNOP9, weights.class0 = dmc1label, curve = T)$curve
tmp <- pr.curve(scores.class0 = probs, weights.class0 = dmc1label, curve = T)$curve

plot(tmp, type='l', ylim=c(0,1), ylab='Precision (PPV)', xlab='Recall (TPR, Sensitivity)', main='PROC') + abline(h=0.0615, col='red')
lines(tmpNOP9, col='green')
lines(tmpNOZCW, col='blue')

```

## All interactions

```{r}
summary(glm(isDMC1 ~ enrichment + 
        FC_Zcw_CVC_enrichment + 
        FC_h3k4me3_P9_enrichment+ 
        FC_h3k4me3_UT_enrichment + 
        FC_h3k36me3_P9_enrichment +
        enrichment*FC_Zcw_CVC_enrichment*FC_h3k4me3_P9_enrichment*FC_h3k4me3_UT_enrichment*FC_h3k36me3_P9_enrichment,
    family=binomial(link='logit'),
    data=HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"]))
```



```{r}
# no_each <- length(which(HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"]$isDMC1==T))
# set.seed(42)
# subsetNeg <- sample(which(HP9_peaks[cov_input>8]$isDMC1==F), no_each, replace = F)
# 
# DMC1_glm2 <- glm(isDMC1 ~ enrichment + 
#                   FC_Zcw_CVC_enrichment + 
#                   FC_h3k4me3_P9_enrichment+ 
#                   FC_h3k4me3_UT_enrichment + 
#                   FC_h3k36me3_P9_enrichment,
#     family=binomial(link='logit'),
#     data=HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"][c(subsetNeg, which(HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"]$isDMC1==T))],
#     weights = c(rep(1, no_each), rep(10, no_each)))
# 
# summary(DMC1_glm2)
# 
# confusionMatrix(data = as.factor(predict(DMC1_glm2,
#                                          newdata=HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"], type="response")>0.9988),
#                 reference = as.factor(HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"]$isDMC1==T), positive="TRUE")
```

## Bayesian GLM
b_enrichment = hPrdm9 Nterm
```{r}

bGLMN = brm(
  isDMC1 ~ enrichment + 
                  FC_Zcw_CVC_enrichment + 
                  FC_h3k4me3_P9_enrichment+ 
                  FC_h3k4me3_UT_enrichment + 
                  FC_h3k36me3_P9_enrichment +
                  enrichment:FC_Zcw_CVC_enrichment,
  data = HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"], 
  family = 'bernoulli', 
  prior = set_prior('normal(0, 3)'),
  iter = 1000, 
  chains = 3, 
  cores = 3)

summary(bGLMN)

posterior <- as.array(bGLMN)
bayesplot::mcmc_areas(posterior, pars=c("b_enrichment", "b_FC_Zcw_CVC_enrichment", "b_FC_h3k4me3_P9_enrichment", "b_FC_h3k4me3_UT_enrichment","b_FC_h3k36me3_P9_enrichment", "b_enrichment:FC_Zcw_CVC_enrichment"))
```

## GLM with only N peaks similar to C peaks

```{r, eval=FALSE}
# requires NC_similar to run
HP9N_peaks$isDMC1 <- !is.na(HP9N_peaks$DMC1_enrichment)

DMC1N_glm_NC_similar <- glm(isDMC1 ~ enrichment + 
        FC_Zcw_CVC_enrichment + 
        FC_h3k4me3_P9_enrichment+ 
        FC_h3k4me3_UT_enrichment + 
        FC_h3k36me3_P9_enrichment + 
        enrichment:FC_Zcw_CVC_enrichment,
    family=binomial(link='logit'),
    data=HP9N_peaks[NC_similar & cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"])

summary(DMC1N_glm_NC_similar)
```

```{r, eval=FALSE}
# requires similar_rank to run
bGLMN_sr = brm(
  isDMC1 ~ enrichment + 
                  FC_Zcw_CVC_enrichment + 
                  FC_h3k4me3_P9_enrichment+ 
                  FC_h3k4me3_UT_enrichment + 
                  FC_h3k36me3_P9_enrichment +
                  enrichment:FC_Zcw_CVC_enrichment,
  data = HP9N_peaks[similar_rank & cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"], 
  family = 'bernoulli', 
  prior = set_prior('normal(0, 3)'),
  iter = 1000, 
  chains = 3, 
  cores = 3)

summary(bGLMN_sr)

posterior_sr <- as.array(bGLMN_sr)
bayesplot::mcmc_areas(posterior_sr, pars=c("b_enrichment", "b_FC_Zcw_CVC_enrichment", "b_FC_h3k4me3_P9_enrichment", "b_FC_h3k4me3_UT_enrichment","b_FC_h3k36me3_P9_enrichment", "b_enrichment:FC_Zcw_CVC_enrichment")) + xlim(-1,3)
bayesplot::mcmc_areas(posterior, pars=c("b_enrichment", "b_FC_Zcw_CVC_enrichment", "b_FC_h3k4me3_P9_enrichment", "b_FC_h3k4me3_UT_enrichment","b_FC_h3k36me3_P9_enrichment", "b_enrichment:FC_Zcw_CVC_enrichment")) + xlim(-1,3)
```


N term better at predicting due to better Nterm Prdm9 correlation with Dmc1, but unfair to compare Zcwpw1 which was co-transfected with cterm P9 with the nterm P9

# HP9 Cterm GLM

enrichment = hPrdm9 Cterm, has estimate near 0

Because it adds little given Zcw enrichments?

```{r}
HP9combo_peaks$DMC1_enrichment <- foverlaps(HP9combo_peaks, dmc1, mult="first")$enrichment

HP9combo_peaks$isDMC1 <- !is.na(HP9combo_peaks$DMC1_enrichment)

CtermDMC1glm <- glm(isDMC1 ~ enrichment + 
                  FC_Zcw_CVC_enrichment + 
                  FC_h3k4me3_P9_enrichment+ 
                  FC_h3k4me3_UT_enrichment + 
                  FC_h3k36me3_P9_enrichment,
    family=binomial(link='logit'),
    data=HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX"])

summary(CtermDMC1glm)
```

## Preditcion with C term

```{r}

testChrs <- c("chr1","chr3","chr5")

CtermDMC1glmOnlyP9 <- glm(isDMC1 ~ enrichment,
    family=binomial(link='logit'),
    data=HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10][!chr %in% testChrs])

CtermDMC1glmOnlyZCVC <- glm(isDMC1 ~ FC_Zcw_CVC_enrichment,
    family=binomial(link='logit'),
    data=HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10][!chr %in% testChrs])

CtermDMC1glmBoth <- glm(isDMC1 ~ enrichment + FC_Zcw_CVC_enrichment,
    family=binomial(link='logit'),
    data=HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10][!chr %in% testChrs])

CtermDMC1glmOnlyZwP9 <- glm(isDMC1 ~ FC_Zcw_wP9_enrichment,
    family=binomial(link='logit'),
    data=HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10][!chr %in% testChrs])

CtermDMC1glmHist <- glm(isDMC1 ~ FC_h3k4me3_P9_enrichment+ 
                  FC_h3k4me3_UT_enrichment + 
                  FC_h3k36me3_P9_enrichment,
    family=binomial(link='logit'),
    data=HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10][!chr %in% testChrs])

CtermDMC1glmAll <- glm(isDMC1 ~ enrichment + FC_Zcw_CVC_enrichment + FC_h3k4me3_P9_enrichment+ 
                  FC_h3k4me3_UT_enrichment + 
                  FC_h3k36me3_P9_enrichment,
    family=binomial(link='logit'),
    data=HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10][!chr %in% testChrs])


summary(CtermDMC1glmOnlyP9)
summary(CtermDMC1glmOnlyZCVC)
summary(CtermDMC1glmBoth)
summary(CtermDMC1glmOnlyZwP9)
summary(CtermDMC1glmHist)

probs1 = predict(CtermDMC1glmOnlyP9,
                newdata = HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10][chr %in% testChrs],
                type = "response")

probs2 = predict(CtermDMC1glmOnlyZCVC,
                newdata = HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10][chr %in% testChrs],
                type = "response")

probs3 = predict(CtermDMC1glmBoth,
                newdata = HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10][chr %in% testChrs],
                type = "response")

probs4 = predict(CtermDMC1glmAll,
                newdata = HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10][chr %in% testChrs],
                type = "response")

probs5 = predict(CtermDMC1glmHist,
                newdata = HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10][chr %in% testChrs],
                type = "response")


dmc1label1 = HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10][chr %in% testChrs]$isDMC1


caret::confusionMatrix(data = as.factor(probs1>0.05),
                reference = as.factor(dmc1label1), positive = "TRUE")

# ROC Curve
tmp1 <- roc.curve(scores.class0 = probs1, weights.class0 = dmc1label1, curve = T)$curve
tmp2 <- roc.curve(scores.class0 = probs2, weights.class0 = dmc1label1, curve = T)$curve
tmp3 <- roc.curve(scores.class0 = probs3, weights.class0 = dmc1label1, curve = T)$curve
tmp4 <- roc.curve(scores.class0 = probs4, weights.class0 = dmc1label1, curve = T)$curve
tmp5 <- roc.curve(scores.class0 = probs5, weights.class0 = dmc1label1, curve = T)$curve

tmpP <- pROC::roc(dmc1label1, probs1)

# plot(tmp1, type='l', ylim=c(0,1), ylab='Sensitivity (TPR, Recall)', xlab='1-Specificity (FPR)', main='ROC') + abline(0,1, col='red')
# lines(tmp2, col="blue")
# lines(tmp3, col="green")

tmp1 <- data.table(tmp1)
tmp2 <- data.table(tmp2)
tmp3 <- data.table(tmp3)
tmp4 <- data.table(tmp4)
tmp5 <- data.table(tmp5)

tmp1$Predictors <- "PRDM9 Only"
tmp2$Predictors <- "ZCWPW1 (PRDM9-dependent) Only"
tmp3$Predictors <- "Both"
tmp4$Predictors <- "All"
tmp5$Predictors <- "H3K4me3" # better, but co-transfection efficieny..??
```


```{r DMC1_ROC_PR, fig.width=10, fig.height=5}
p1 <- ggplot(rbind(tmp1, tmp2, tmp3), aes(V1, V2, colour=Predictors)) +
  geom_line() + 
  scale_color_brewer(palette = "Set1") + 
  geom_abline(slope = 1, intercept = 0, linetype="dashed") + 
  theme_minimal() + 
  theme(legend.position = "bottom") + 
  ylab('Sensitivity (TPR, Recall)') +
  xlab('1-Specificity (FPR)')

# PR Curve
tmp1 <- pr.curve(scores.class0 = probs1, weights.class0 = dmc1label1, curve = T)$curve
tmp2 <- pr.curve(scores.class0 = probs2, weights.class0 = dmc1label1, curve = T)$curve
tmp3 <- pr.curve(scores.class0 = probs3, weights.class0 = dmc1label1, curve = T)$curve

tmp1 <- data.table(tmp1)
tmp2 <- data.table(tmp2)
tmp3 <- data.table(tmp3)

tmp1$Predictors <- "PRDM9 Only"
tmp2$Predictors <- "ZCWPW1 (PRDM9-dependent) Only"
tmp3$Predictors <- "Both"

p2 <- ggplot(rbind(tmp1, tmp2, tmp3)[V1>0.005], aes(V1, V2, colour=Predictors)) +
  geom_line() + 
  scale_color_brewer(palette = "Set1") + 
  geom_hline(yintercept = mean(dmc1label1), linetype="dashed") + 
  theme_minimal() + 
  theme(legend.position = "bottom") + 
  ylab('Precision (PPV)') +
  xlab('Recall (TPR, Sensitivity)')
  


pmain <- plot_grid(p1+theme(legend.position = "none"),
                   p2+theme(legend.position = "none"))

#pdf("../results/DMC1_ROC_PR.pdf", width=10, height = 5)
plot_grid(pmain, get_legend(p1), ncol=1, rel_heights = c(1, 0.07))
#dev.off()
```

```{r}
bGLMN_C = brm(
  isDMC1 ~ enrichment + 
                  FC_Zcw_CVC_enrichment + 
                  FC_h3k4me3_P9_enrichment+ 
                  FC_h3k4me3_UT_enrichment + 
                  FC_h3k36me3_P9_enrichment +
                  enrichment:FC_Zcw_CVC_enrichment,
  data = HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5 & FC_h3k4me3_P9_cov_input>5 & FC_h3k4me3_UT_cov_input>5 & FC_h3k36me3_P9_cov_input>5 & chr != "chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10], 
  family = 'bernoulli', 
  prior = set_prior('normal(0, 3)'),
  iter = 1000, 
  chains = 3, 
  cores = 3)

summary(bGLMN_C)

posterior_C <- as.array(bGLMN_C)
bayesplot::mcmc_areas(posterior_C, pars=c("b_enrichment", "b_FC_Zcw_CVC_enrichment", "b_FC_h3k4me3_P9_enrichment", "b_FC_h3k4me3_UT_enrichment","b_FC_h3k36me3_P9_enrichment", "b_enrichment:FC_Zcw_CVC_enrichment")) + xlim(-1,3)
```


# Prdm9 peaks vs Force Called Zcw

NB absolute numbers similar

```{r}
sum(HP9combo_peaks[cov_input>8]$FC_Zcw_CVC_pvalue<1e-6)
sum(HP9N_peaks[cov_input>8]$FC_Zcw_CVC_pvalue<1e-6)
```


```{r}
fraction_overlap_FC_pthresh(HP9combo_peaks[cov_input>8],"HP9combo", "FC_Zcw_CVC_pvalue")
fraction_overlap_FC_pthresh(HP9N_peaks[cov_input>8],"HP9 N", "FC_Zcw_CVC_pvalue")

fraction_overlap_FC_mean(HP9combo_peaks[cov_input>8 & FC_Zcw_CVC_enrichment<10],"HP9combo", "FC_Zcw_CVC_enrichment")
fraction_overlap_FC_mean(HP9N_peaks[cov_input>8 & FC_Zcw_CVC_enrichment<10],"HP9 N", "FC_Zcw_CVC_enrichment")

head(Zcw_CVC_AT_hP9combo[order(-enrichment)],10)
head(Zcw_CVC_AT_hP9N[order(-enrichment)],10)

```

# Visualising Discrimination, C vs N term

```{r DMC1_density}
ggplot(HP9combo_peaks[cov_input>5], aes(enrichment, FC_Zcw_CVC_enrichment)) +
  geom_point(size=0.1, alpha=0.5) +
  scale_y_log10() + scale_x_log10() + facet_wrap(~isDMC1)

ggplot(HP9N_peaks[cov_input>5], aes(enrichment, FC_Zcw_CVC_enrichment)) +
  geom_point(size=0.1, alpha=0.5) +
  scale_y_log10() + scale_x_log10() + facet_wrap(~isDMC1)

ggplot(HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5], aes(FC_Zcw_CVC_enrichment, color=isDMC1)) +
  geom_density() +
  scale_x_log10() + ggtitle("Cterm")

ggplot(HP9N_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5], aes(FC_Zcw_CVC_enrichment, color=isDMC1)) +
  geom_density() +
  scale_x_log10() + ggtitle("Nterm") + geom_vline(xintercept = 0.9, linetype="dashed")

p1 <- ggplot(HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5], aes(FC_Zcw_CVC_enrichment, fill=isDMC1)) +
    geom_density(alpha=0.5) +
    scale_x_log10(limits=c(1e-2, 5)) +  theme_minimal() + theme(legend.position = "none") + scale_fill_brewer(palette = "Set1") + xlab("Enrichment of Zcwpw1 (with vs without humanPrdm9)")

p2 <- ggplot(HP9combo_peaks[cov_input>5 & FC_Zcw_CVC_cov_input>5], aes(enrichment, fill=isDMC1)) +
    geom_density(alpha=0.5) +
    scale_x_log10(limits=c(0.5, 50)) +  theme_minimal() + scale_fill_brewer(palette = "Set1") + xlab("Enrichment of humanPrdm9")

#pdf("../results/DMC1_density.pdf", width=10, height = 5)
plot_grid(p1, p2)
#dev.off()
```

# Average DMC1 Overlap HP9 C term

3 to 6 ratio in DMC1 overlap

```{r}
#% HP9 C that have 0 Zcw_CVC enrich
mean(HP9combo_peaks[cov_input>8]$FC_Zcw_CVC_enrichment==0)

#% HP9 C that overlap DMC1
mean(HP9combo_peaks[cov_input>8 & chr != "chrX"]$isDMC1)

quantile(HP9combo_peaks$FC_Zcw_CVC_enrichment)

# %DMC1 overlap for 1st and 2nd half of data by Zcw_CVC enrichment
mean(HP9combo_peaks[cov_input>8 & chr != "chrX" & FC_Zcw_CVC_enrichment<quantile(HP9combo_peaks$FC_Zcw_CVC_enrichment, 0.5)]$isDMC1)
mean(HP9combo_peaks[cov_input>8 & chr != "chrX" & FC_Zcw_CVC_enrichment>quantile(HP9combo_peaks$FC_Zcw_CVC_enrichment, 0.5)]$isDMC1)

# %DMC1 overlap for bottom 25% and top 15% data by Zcw_CVC enrichment
mean(HP9combo_peaks[cov_input>8 & chr != "chrX" & FC_Zcw_CVC_enrichment<quantile(HP9combo_peaks$FC_Zcw_CVC_enrichment, 0.25)]$isDMC1)
mean(HP9combo_peaks[cov_input>8 & chr != "chrX" & FC_Zcw_CVC_enrichment>quantile(HP9combo_peaks$FC_Zcw_CVC_enrichment, 0.85)]$isDMC1)
```

# Average DMC1 Overlap HP9 N

High fraction of 0 Zcw_CVC enrichments - maybe because it's going to the Prdm9-Cterm sites?

2.6 to 4.8 fold ratio in % DMC1

```{r}
# % HP9 N that have 0 Zcw_CVC enrich
mean(HP9N_peaks[cov_input>8]$FC_Zcw_CVC_enrichment==0)

# % HP9 N that overlap DMC1
mean(HP9N_peaks[cov_input>8& chr != "chrX"]$isDMC1)

quantile(HP9N_peaks$FC_Zcw_CVC_enrichment)

# %DMC1 overlap for 1st and 2nd half of data by Zcw_CVC enrichment
mean(HP9N_peaks[cov_input>8 & chr != "chrX" & FC_Zcw_CVC_cov_input>5& FC_Zcw_CVC_enrichment<quantile(HP9N_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"]$FC_Zcw_CVC_enrichment, 0.5)]$isDMC1)
mean(HP9N_peaks[cov_input>8 & chr != "chrX" & FC_Zcw_CVC_cov_input>5& FC_Zcw_CVC_enrichment>quantile(HP9N_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"]$FC_Zcw_CVC_enrichment, 0.5)]$isDMC1)

# %DMC1 overlap for bottom 25% and top 15% data by Zcw_CVC enrichment
mean(HP9N_peaks[cov_input>8 & chr != "chrX" & FC_Zcw_CVC_cov_input>5& FC_Zcw_CVC_enrichment<=quantile(HP9N_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"]$FC_Zcw_CVC_enrichment, 0.25)]$isDMC1)
mean(HP9N_peaks[cov_input>8 & chr != "chrX" & FC_Zcw_CVC_cov_input>5& FC_Zcw_CVC_enrichment>quantile(HP9N_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"]$FC_Zcw_CVC_enrichment, 0.85)]$isDMC1)
```

# Line splitting

```{r}

fraction_overlap_FC6 <- function(dt,n=100){
     setorder(dt, enrichment)
     binning_vector <- cut(1:nrow(dt), n)
     return(tapply(!is.na(dt$DMC1_enrichment), binning_vector, mean))
}


bins=15
plot(fraction_overlap_FC6(HP9combo_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"],n=bins), ylim=c(0,0.6), xlab="Bin HP9 Peaks, low to high enrich", ylab="DMC1 Overlap", main="Cterm, black=all, blue is ZcwCVCenrich<0.8, red>0.8")
points(fraction_overlap_FC6(HP9combo_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"][FC_Zcw_CVC_enrichment<0.8],n=bins), ylim=c(0,0.5), col='blue')
points(fraction_overlap_FC6(HP9combo_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"][FC_Zcw_CVC_enrichment>0.8], n=bins), col='red')


plot(fraction_overlap_FC6(HP9N_peaks[cov_input>=4 & FC_Zcw_CVC_cov_input>=5 & chr!="chrX"],n=bins), ylim=c(0,0.95), xlab="Bin HP9 N Peaks, low to high enrich",  ylab="DMC1 Overlap", main="Nterm, black=all, blue is ZcwCVCenrich<0.8, red>0.8")
points(fraction_overlap_FC6(HP9N_peaks[cov_input>=4 & FC_Zcw_CVC_cov_input>=5 & chr!="chrX"][FC_Zcw_CVC_enrichment<0.3],n=bins), ylim=c(0,0.5), col='blue')
points(fraction_overlap_FC6(HP9N_peaks[cov_input>=4 & FC_Zcw_CVC_cov_input>=5 & chr!="chrX"][FC_Zcw_CVC_enrichment>1], n=bins), col='red')

split_overlap <- function(dt, n=10, filters, returndf=F){
  setorder(dt, enrichment)
  dt$enrichment_bin <- cut(1:nrow(dt), n)

  All=TRUE
  
  tmp <- rbind(
    dt[eval(parse(text=filters[1])),.(mean_enrichment=mean(enrichment),
                                      num=.N,
                                      DMC1_Overlap=mean(!is.na(DMC1_enrichment)),subset=filters[1],
                                      sem=sd(!is.na(DMC1_enrichment))/sqrt(length(DMC1_enrichment)),
                                      sep=sqrt((mean(!is.na(DMC1_enrichment)) * (1- mean(!is.na(DMC1_enrichment))))/length(DMC1_enrichment))),by=enrichment_bin],
    dt[eval(parse(text=filters[2])),.(mean_enrichment=mean(enrichment),
                                      num=.N,
                                      DMC1_Overlap=mean(!is.na(DMC1_enrichment)),subset=filters[2],
                                      sem=sd(!is.na(DMC1_enrichment))/sqrt(length(DMC1_enrichment)),
                                      sep=sqrt((mean(!is.na(DMC1_enrichment)) * (1- mean(!is.na(DMC1_enrichment))))/length(DMC1_enrichment))),by=enrichment_bin],
    dt[eval(parse(text=filters[3])),.(mean_enrichment=mean(enrichment),
                                      num=.N,
                                      DMC1_Overlap=mean(!is.na(DMC1_enrichment)),subset=filters[3],
                                      sem=sd(!is.na(DMC1_enrichment))/sqrt(length(DMC1_enrichment)),
                                      sep=sqrt((mean(!is.na(DMC1_enrichment)) * (1- mean(!is.na(DMC1_enrichment))))/length(DMC1_enrichment))),by=enrichment_bin])

  #sqrt((p  * (1 - p)) / tries)
  #rep(1:n,3)
  
  if(returndf){
    return(tmp)
  }else{
  return(
    ggplot(tmp, aes(mean_enrichment, DMC1_Overlap, colour=subset, group=subset)) +
      #geom_point(size=2) +
      geom_pointrange(aes(ymax = DMC1_Overlap + 2*sem, ymin = DMC1_Overlap - 2*sem)) +
      theme_minimal() +
      scale_color_brewer(palette = 'Set1') +
      xlab("Mean hPrdm9-N Enrichment") + scale_x_log10()
  )}
}



split_overlap(HP9N_peaks[cov_input>=4 & FC_Zcw_CVC_cov_input>=5 & chr!="chrX" & cov_input<200 & FC_Zcw_CVC_enrichment<10],
              filters=c("All",
                        "FC_Zcw_CVC_enrichment<0.3",
                        "FC_Zcw_CVC_enrichment>0.9")) + ylim(0,0.5) + theme(legend.position = "bottom")

split_overlap(HP9N_peaks[cov_input>=4 & FC_Zcw_CVC_cov_input_flank150>=5 & chr!="chrX"],
              filters=c("All",
                        "FC_Zcw_CVC_enrichment_flank150<0.3",
                        "FC_Zcw_CVC_enrichment_flank150>0.9")) + ylim(0,0.5) + theme(legend.position = "bottom")


split_overlap(HP9N_peaks[cov_input>=4 & FC_Zcw_CVC_cov_input_flank150>=5 & chr!="chrX"],
              filters=c("All",
                        "FC_Zcw_CVC_enrichment_flank150<0.3",
                        "FC_Zcw_CVC_enrichment_flank150>0.8")) + ylim(0,0.5) + theme(legend.position = "bottom")


tmp <- split_overlap(HP9N_peaks[cov_input>=4 & FC_Zcw_CVC_cov_input>=5 & chr!="chrX"],
              filters=c("All",
                        "FC_Zcw_CVC_enrichment<0.3",
                        "FC_Zcw_CVC_enrichment>0.9"), returndf = T)

# fold change
tmp <- dcast(tmp[subset!="All"], formula = enrichment_bin ~ subset,  value.var="DMC1_Overlap")
setnames(tmp, c("bin",'low','high'))
ggplot(tmp, aes(bin, high/low)) + geom_point()


split_overlap(HP9N_peaks[cov_input>=4 & chr!="chrX"],
              filters=c("All",
                        "FC_Zcw_enrichment<0.01",
                        "FC_Zcw_enrichment>1")) + ylim(0,0.5)

split_overlap(HP9N_peaks[cov_input>=4 & chr!="chrX"],
              filters=c("All",
                        "FC_h3k4me3_UT_enrichment<0.01",
                        "FC_h3k4me3_UT_enrichment>1"))

```




```{r}
plot(fraction_overlap_FC6(HP9N_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"],n=bins), ylim=c(0,0.7), ylab="DMC1 Overlap", xlab="Bin HP9 N Peaks, low to high enrich", main="Nterm, black=all, red is ZcwCVCenrich<1, green>0.2")
points(fraction_overlap_FC6(HP9N_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"][FC_Zcw_CVC_enrichment<0.2],n=bins), ylim=c(0,0.5), col='green')
points(fraction_overlap_FC6(HP9N_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"][FC_Zcw_CVC_enrichment>1], n=bins), col='red')

bins=15
plot(fraction_overlap_FC6(HP9combo_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"][FC_Zcw_CVC_enrichment>1], n=bins) /
      fraction_overlap_FC6(HP9combo_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"][FC_Zcw_CVC_enrichment<0.2],n=bins), 
     ylab='DMC1 enrichment ratio ZcwCVCenrich>1 vs <0.2', xlab="Cterm Prdm9 Enrichment bin", ylim=c(1,50), log='y')

plot(fraction_overlap_FC6(HP9N_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"][FC_Zcw_CVC_enrichment>1], n=bins) /
         fraction_overlap_FC6(HP9N_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"][FC_Zcw_CVC_enrichment<0.2],n=bins), 
     ylab='DMC1 enrichment ratio ZcwCVCenrich>1 vs <0.2', xlab="Nterm Prdm9 Enrichment bin", ylim=c(1,50), log='y')

fraction_overlap_FC7 <- function(dt,x,y,n=100){
     setorder(dt, FC_Zcw_CVC_enrichment)
     binning_vector <- cut(1:nrow(dt), n)
     plot(1:n/n, tapply(!is.na(dt$DMC1_enrichment), binning_vector, mean),
          xlab=paste("Fraction of hPrdm9 Peaks (ordered low to high ZCW_CVC enrichment)"),
          ylab=paste("Fraction of hPrdm9 peaks overlapping with DMC1 peak"))  
}

fraction_overlap_FC7(HP9combo_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"], x="ZCVC",y="DMC1")

```



# Split the Split

```{r}

# split_the_split <- function(bin, n1, n2){
#   dt <- HP9N_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"]
#   setorder(dt, enrichment) #FC_Zcw_CVC_enrichment
#   binning_vector <- cut(1:nrow(dt), n1)
# 
#   dt <- dt[as.numeric(binning_vector)==bin]
#   setorder(dt, FC_Zcw_CVC_enrichment)
#   binning_vector <- cut(1:nrow(dt), n2)
#   return(tapply(!is.na(dt$DMC1_enrichment), binning_vector, mean))
# }

split_the_split <- function(bin, n1, n2){
  dt <- HP9N_peaks[cov_input>8 & FC_Zcw_CVC_cov_input>5 & chr!="chrX"]
  setorder(dt, enrichment) #FC_Zcw_CVC_enrichment
  binning_vector <- cut(1:nrow(dt), n1)

  dt <- dt[as.numeric(binning_vector)==bin]
  return(dt[,mean(!is.na(DMC1_enrichment)),by=FC_Zcw_CVC_enrichment_bin][order(FC_Zcw_CVC_enrichment_bin)]$V1)
}

HP9N_peaks[FC_Zcw_CVC_enrichment<0.01, FC_Zcw_CVC_enrichment_bin:=1]
HP9N_peaks[FC_Zcw_CVC_enrichment>0.01, FC_Zcw_CVC_enrichment_bin:=2]
HP9N_peaks[FC_Zcw_CVC_enrichment>0.1, FC_Zcw_CVC_enrichment_bin:=3]
HP9N_peaks[FC_Zcw_CVC_enrichment>0.2, FC_Zcw_CVC_enrichment_bin:=4]
HP9N_peaks[FC_Zcw_CVC_enrichment>0.4, FC_Zcw_CVC_enrichment_bin:=5]
HP9N_peaks[FC_Zcw_CVC_enrichment>0.6, FC_Zcw_CVC_enrichment_bin:=6]
HP9N_peaks[FC_Zcw_CVC_enrichment>1, FC_Zcw_CVC_enrichment_bin:=7]

n1=6  # Prdm9 enrichment bin
n2=7 # Zcw enrichment bin
cols=RColorBrewer::brewer.pal(n1,name="YlOrRd")

par(bg = "grey")
plot(1:n2, split_the_split(1,n1,n2), type="l", col=cols[1], ylim=c(0,0.35),
     xlab='Bin of Zcw_CVC enrichment (low to high)',
     ylab='Fraction of HP9N Peaks (dark = high P9 enrich) that overlap DMC1')
grid(col='black', ny = 10)
for(i in 2:n1){
  lines(1:n2, split_the_split(i,n1,n2), type="l", col=cols[i])  
}

par(bg = "grey")
plot(1:n2, split_the_split(1,n1,n2), type="l", col=cols[1], ylim=c(0.0035,0.35),
     xlab='Bin of Zcw_CVC enrichment (low to high)',
     ylab='Fraction of HP9N Peaks (dark = high P9 enrich) that overlap DMC1', log='y')
grid(col='black', ny = 10)
for(i in 2:n1){
  lines(1:n2, split_the_split(i,n1,n2), type="l", col=cols[i])  
}


```


