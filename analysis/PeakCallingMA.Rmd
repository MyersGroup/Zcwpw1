---
title: "Peak Calling"
output: 
  html_notebook: 
    code_folding: show
    fig_height: 6
    fig_width: 10.5
    results: hold
    fig_show: hold
    toc: yes
    toc_float: yes
    number_sections: yes
    theme: spacelab
---


```{r}
knitr::opts_knit$set(base.dir = "results")
knitr::opts_chunk$set(fig.path = "single_base_peaks/")
knitr::opts_chunk$set(dev="pdf")
knitr::opts_chunk$set(fig.show="hold")

library(data.table)
library(ggplot2)
library(cowplot)
library(mgcv)
#devtools::install_github("zeehio/facetscales")
library(facetscales) # for proportions plot

source("../functions.R")
```


# Load Results

```{r}

# HA TAG UNLESS OTHERWISE SPECIFIED

zcw_peaks <- fread("../data/peaks/SingleBasePeaks.WTCHG_538916_221156_vs_WTCHG_538916_217108.p0.000001.sep250.ALL.bed")

zcw_peaks_cin <- fread("../data/peaks/SingleBasePeaks.WTCHG_538916_221156_vs_WTCHG_538916_217108_AND_WTCHG_538916_220144.p0.000001.sep250.ALL.bed")


zcw_wP9_peaks <- fread("../data/peaks/SingleBasePeaks.WTCHG_538916_223180_vs_WTCHG_538916_220144.p0.000001.sep250.ALL.bed")
zcw_wP9_peaks_cin <- fread("../data/peaks/SingleBasePeaks.WTCHG_538916_223180_vs_WTCHG_538916_217108_AND_WTCHG_538916_220144.p0.000001.sep250.ALL.bed")

zcw_wP9_vs_chip_Z <- fread("../data/peaks/SingleBasePeaks.WTCHG_538916_223180_vs_WTCHG_538916_221156.p0.000001.sep250.ALL.bed")

zcw_wcP9_peaks_cin <- fread("../data/peaks/SingleBasePeaks.WTCHG_538916_224192_vs_WTCHG_538916_217108_AND_WTCHG_538916_220144.p0.000001.sep250.ALL.bed")
zcw_wcP9_vs_chip_Z <- fread("../data/peaks/SingleBasePeaks.WTCHG_538916_224192_vs_WTCHG_538916_221156.p0.000001.sep250.ALL.bed")


HP9_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627146_vs_NA15-SRR5627143.p0.000001.sep250.ALL.bed")
HP9V5_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627147_vs_NA15-SRR5627143.p0.000001.sep250.ALL.bed")

HP9combo_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627146_AND_NA15-SRR5627147_vs_NA15-SRR5627143.p0.000001.sep250.ALL.bed")


CP9_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627144_vs_NA15-SRR5627143.p0.000001.sep250.ALL.bed")

CP9V5_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627145_vs_NA15-SRR5627143.p0.000001.sep250.ALL.bed")

CP9combo_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627145_AND_NA15-SRR5627144_vs_NA15-SRR5627143.p0.000001.sep250.ALL.bed")


HP9N_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627138_AND_NA15-SRR5627139_vs_NA15-SRR5627140.p0.000001.sep250.ALL.bed")

h3k4me3_P9_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627152_AND_NA15-SRR5627153_vs_NA15-SRR5627143.p0.000001.sep250.ALL.bed")
h3k36me3_P9_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627149_vs_NA15-SRR5627143.p0.000001.sep250.ALL.bed")

h3k4me3_UT_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627150_vs_NA15-SRR5627142.p0.000001.sep250.ALL.bed")
h3k36me3_UT_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627148_vs_NA15-SRR5627142.p0.000001.sep250.ALL.bed")

h3k4me3_P9vsUT_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627152_AND_NA15-SRR5627153_vs_NA15-SRR5627150_AND_NA15-SRR5627151.p0.000001.sep250.ALL.bed")
h3k36me3_P9vsUT_peaks <- fread("../data/peaks/SingleBasePeaks.NA15-SRR5627149_vs_NA15-SRR5627148.p0.000001.sep250.ALL.bed")

```



## Number of peaks

```{r}

number_of_peaks=c(
nrow(zcw_peaks[cov_input>5]),
nrow(zcw_peaks_cin[cov_input>5]),
nrow(zcw_wP9_peaks[cov_input>5]),
nrow(zcw_wP9_peaks_cin[cov_input>5]),
nrow(zcw_wP9_vs_chip_Z[cov_input>5]),
nrow(zcw_wcP9_peaks_cin[cov_input>5]),
nrow(zcw_wcP9_vs_chip_Z[cov_input>5]),
nrow(HP9_peaks[cov_input>5]),
nrow(HP9V5_peaks[cov_input>5]),
nrow(HP9combo_peaks[cov_input>5]),
nrow(HP9N_peaks[cov_input>5]),
nrow(CP9_peaks[cov_input>5]),
nrow(h3k4me3_P9_peaks[cov_input>5]),
nrow(h3k36me3_P9_peaks[cov_input>5]),
nrow(h3k4me3_UT_peaks[cov_input>5]),
nrow(h3k36me3_UT_peaks[cov_input>5]),
nrow(h3k4me3_P9vsUT_peaks[cov_input>5]),
nrow(h3k36me3_P9vsUT_peaks[cov_input>5]))

experiment=c('Zcw',
             'Zcw_cinput',
            'Zcw_wP9',
            'Zcw_wP9_cinput',
            'zcw_wP9_vs_chip_Z',
            'Zcw_wcP9_cinput',
            'zcw_wcP9_vs_chip_Z',
            'HP9',
            'HP9V5',
            'HP9V5&HA',
            'HP9-Nterm',
            'CP9',
            'h3k4me3_P9',
            'h3k36me3_P9',
            'h3k4me3_UT',
            'h3k36me3_UT',
            'h3k4me3_P9vsUT',
            'h3k36me3_P9vsUT')

ggplot(data.table(number_of_peaks, experiment), aes(experiment, number_of_peaks)) + geom_col() + coord_flip()

number_of_peaks=c(
nrow(zcw_peaks),
nrow(zcw_peaks_cin),
nrow(zcw_wP9_peaks),
nrow(zcw_wP9_peaks_cin),
nrow(zcw_wP9_vs_chip_Z),
nrow(zcw_wcP9_peaks_cin),
nrow(zcw_wcP9_vs_chip_Z),
nrow(HP9_peaks),
nrow(HP9V5_peaks),
nrow(HP9combo_peaks),
nrow(HP9N_peaks),
nrow(CP9_peaks),
nrow(h3k4me3_P9_peaks),
nrow(h3k36me3_P9_peaks),
nrow(h3k4me3_UT_peaks),
nrow(h3k36me3_UT_peaks),
nrow(h3k4me3_P9vsUT_peaks),
nrow(h3k36me3_P9vsUT_peaks))

ggplot(data.table(number_of_peaks, experiment), aes(experiment, number_of_peaks)) + geom_col() + coord_flip()
```

Enrichment value distributions

```{r enrich_dist}
ggplot(cbind(zcw_peaks, exp='Zcw'), aes(enrichment))+
  geom_density() +
  scale_x_log10() +
  geom_density(data=cbind(zcw_wP9_peaks[cov_input>5], exp='zcw_wP9')) +
  geom_density(data=cbind(zcw_wcP9_peaks_cin[cov_input>5], exp='zcw_wcP9')) +
  geom_density(data=cbind(zcw_wP9_vs_chip_Z[cov_input>5], exp='zcw_wP9_vs_chip_Z')) +
  geom_density(data=cbind(zcw_wcP9_vs_chip_Z[cov_input>5], exp='zcw_wcP9_vs_chip_Z')) +
  geom_density(data=cbind(HP9_peaks[cov_input>5], exp='hPrdm9')) +
  geom_density(data=cbind(HP9V5_peaks[cov_input>5], exp='hPrdm9V5')) +
  geom_density(data=cbind(HP9combo_peaks[cov_input>5], exp='hPrdm9V5&HA')) +
  geom_density(data=cbind(HP9N_peaks[cov_input>5], exp='hPrdm9-Nterm')) +
  geom_density(data=cbind(h3k4me3_UT_peaks[cov_input>5], exp='h3k4me3_UT')) +
  geom_density(data=cbind(h3k4me3_P9_peaks[cov_input>5], exp='h3k4me3_P9')) +
  geom_density(data=cbind(h3k36me3_UT_peaks[cov_input>5], exp='h3k36me3_UT')) +
  geom_density(data=cbind(h3k36me3_P9_peaks[cov_input>5], exp='h3k36me3_P9')) + 
  scale_color_brewer(type="qual", palette = "Set1") + facet_wrap("~exp")
```

Cov input distributions

```{r cov_input_dist}

ggplot(cbind(zcw_peaks, exp='Zcw'), aes(cov_input))+
    geom_histogram(bins=100) +
    xlim(1,25) +
    geom_histogram(bins=100, data=cbind(zcw_wP9_peaks[cov_input>=0], exp='zcw_wP9')) +
  geom_histogram(bins=100, data=cbind(zcw_wP9_peaks_cin[cov_input>=0], exp='zcw_wP9_cin')) +
    geom_histogram(bins=100, data=cbind(HP9_peaks[cov_input>=0], exp='hPrdm9')) +
    geom_histogram(bins=100, data=cbind(HP9V5_peaks[cov_input>=0], exp='hPrdm9V5')) +
    geom_histogram(bins=100, data=cbind(HP9combo_peaks[cov_input>=0], exp='hPrdm9V5&HA')) +
    geom_histogram(bins=100, data=cbind(HP9N_peaks[cov_input>=0], exp='hPrdm9-Nterm')) +
    geom_histogram(bins=100, data=cbind(h3k4me3_UT_peaks[cov_input>=0], exp='h3k4me3_UT')) +
    geom_histogram(bins=100, data=cbind(h3k4me3_P9_peaks[cov_input>=0], exp='h3k4me3_P9')) +
    geom_histogram(bins=100, data=cbind(h3k36me3_UT_peaks[cov_input>=0], exp='h3k36me3_UT')) +
    geom_histogram(bins=100, data=cbind(h3k36me3_P9_peaks[cov_input>=0], exp='h3k36me3_P9')) + 
    scale_color_brewer(type="qual", palette = "Set1") + facet_wrap("~exp", scale="free_y")
```

replicate 1 read count distributions

```{r read_count_dist}
ggplot(cbind(zcw_peaks, exp='Zcw'), aes(cov_r1))+
    geom_histogram(binwidth = 1) +
    xlim(1,70) +
    geom_histogram(binwidth = 1, data=cbind(zcw_wP9_peaks[cov_input>=0], exp='zcw_wP9')) +
    geom_histogram(binwidth = 1, data=cbind(HP9_peaks[cov_input>=0], exp='hPrdm9')) +
    geom_histogram(binwidth = 1, data=cbind(HP9V5_peaks[cov_input>=0], exp='hPrdm9V5')) +
    geom_histogram(binwidth = 1, data=cbind(HP9combo_peaks[cov_input>=0], exp='hPrdm9V5&HA')) +
    geom_histogram(binwidth = 1, data=cbind(HP9N_peaks[cov_input>=0], exp='hPrdm9-Nterm')) +
    geom_histogram(binwidth = 1, data=cbind(h3k4me3_UT_peaks[cov_input>=0], exp='h3k4me3_UT')) +
    geom_histogram(binwidth = 1, data=cbind(h3k4me3_P9_peaks[cov_input>=0], exp='h3k4me3_P9')) +
    geom_histogram(binwidth = 1, data=cbind(h3k36me3_UT_peaks[cov_input>=0], exp='h3k36me3_UT')) +
    geom_histogram(binwidth = 1, data=cbind(h3k36me3_P9_peaks[cov_input>=0], exp='h3k36me3_P9')) + 
    scale_color_brewer(type="qual", palette = "Set1") + facet_wrap("~exp", scale="free_y")

```



# Functions

```{r prejoin}

HP9_peaks <- prejoin(HP9_peaks)
HP9N_peaks <- prejoin(HP9N_peaks)
HP9V5_peaks <- prejoin(HP9V5_peaks)
CP9V5_peaks <- prejoin(CP9V5_peaks)
HP9combo_peaks <- prejoin(HP9combo_peaks)
CP9combo_peaks <- prejoin(CP9combo_peaks)
zcw_peaks <- prejoin(zcw_peaks)
zcw_peaks_cin <- prejoin(zcw_peaks_cin)
zcw_wP9_peaks <- prejoin(zcw_wP9_peaks)
zcw_wP9_peaks_cin <- prejoin(zcw_wP9_peaks_cin)
zcw_wcP9_peaks_cin <- prejoin(zcw_wcP9_peaks_cin)

zcw_wP9_vs_chip_Z <- prejoin(zcw_wP9_vs_chip_Z)
zcw_wcP9_vs_chip_Z <- prejoin(zcw_wcP9_vs_chip_Z)


h3k4me3_P9_peaks <- prejoin(h3k4me3_P9_peaks)
h3k36me3_P9_peaks <- prejoin(h3k36me3_P9_peaks)
h3k4me3_UT_peaks <- prejoin(h3k4me3_UT_peaks)
h3k36me3_UT_peaks <- prejoin(h3k36me3_UT_peaks)

h3k4me3_P9vsUT_peaks <- prejoin(h3k4me3_P9vsUT_peaks)
h3k36me3_P9vsUT_peaks <- prejoin(h3k36me3_P9vsUT_peaks)


```


# Mark TSS

```{r tss}
load_tss <- function(file="../data/genome/wgEncodeGencodeCompV28.txt.cut", flank=400){
encode_tss <- fread(file)
names(encode_tss) <- c("tss","chr","strand","txStart","txEnd")

encode_tss[strand=='+', CI_start_ext := txStart - flank]
encode_tss[strand=='+', CI_stop_ext := txStart + flank]
encode_tss[strand=='-', CI_start_ext := txEnd - flank]
encode_tss[strand=='-', CI_stop_ext := txEnd + flank]

encode_tss <- encode_tss[,.(chr, CI_start_ext, CI_stop_ext,tss)]
setkey(encode_tss, chr, CI_start_ext, CI_stop_ext)
return(encode_tss)
}

encode_tss <- load_tss(flank=1000)

HP9combo_peaks$tss <- foverlaps(HP9combo_peaks, encode_tss, mult = 'first')$tss
HP9N_peaks$tss <- foverlaps(HP9N_peaks, encode_tss, mult = 'first')$tss

CP9combo_peaks$tss <- foverlaps(CP9combo_peaks, encode_tss, mult = 'first')$tss


zcw_wP9_vs_chip_Z$tss <- foverlaps(zcw_wP9_vs_chip_Z, encode_tss, mult = 'first')$tss
zcw_wP9_peaks_cin$tss <- foverlaps(zcw_wP9_peaks_cin, encode_tss, mult = 'first')$tss
zcw_peaks_cin$tss <- foverlaps(zcw_peaks_cin, encode_tss, mult = 'first')$tss

```


# DMC1 peaks

```{r load_dmc1}
dmc1 <- fread("../data/pratto_dmc1/Pratto_human_DSB_Aintersect_autosomal_hg38.bed")
setnames(dmc1, c("chr","CI_start","CI_stop","enrichment","enrichmentAB"))
dmc1 <- prejoin(dmc1)
```


```{r}
# library(GenomicRanges)
# 
# HP9_peaks_G <- makeGRangesFromDataFrame(HP9_peaks, start.field = "CI_start", end.field = "CI_stop", keep.extra.columns = T)
# zcw_wP9_vs_chip_Z_G <- makeGRangesFromDataFrame(zcw_wP9_vs_chip_Z, start.field = "CI_start", end.field = "CI_stop", keep.extra.columns = T)
# 
# queryHits(findOverlaps(HP9_peaks_G, zcw_wP9_vs_chip_Z_G, select = "all"))
```

```{r}
# 
# nrow(HP9combo_peaks)
# sum(!is.na(HP9combo_peaks$DMC1_enrichment))
# sum(!is.na(HP9combo_peaks$zcw_CVC_enrichment))
# sum(!is.na(HP9combo_peaks$zcw_wP9_enrichment))
# sum(!is.na(HP9combo_peaks$zcw_enrichment))
# 
# print("HP9N")
# nrow(HP9N_peaks)
# sum(!is.na(HP9N_peaks$DMC1_enrichment))
# sum(!is.na(HP9N_peaks$zcw_CVC_enrichment))
# sum(!is.na(HP9N_peaks$zcw_wP9_enrichment))
# sum(!is.na(HP9N_peaks$zcw_enrichment))
# 
# print("zcw_CVC")
# nrow(zcw_wP9_vs_chip_Z)
# sum(!is.na(zcw_wP9_vs_chip_Z$DMC1_enrichment))
# sum(!is.na(zcw_wP9_vs_chip_Z$HP9N_enrichment))
# sum(!is.na(zcw_wP9_vs_chip_Z$HP9combo_enrichment))
# 
# print("DMC1")
# nrow(dmc1)
# sum(!is.na(dmc1$HP9combo_peaks_enrichment))
# sum(!is.na(dmc1$HP9N_peaks_enrichment))
# sum(!is.na(dmc1$zcw_enrichment))
# sum(!is.na(dmc1$zcw_wP9_enrichment))
# sum(!is.na(dmc1$Zcw_CVC_enrichment))

```

# Proportions

```{r proportions_function}

create_set_matrix <- function(peaks, k=100, returnpeaks=FALSE){
  peaks$zcw_peaks_enrichment <- foverlaps(peaks, zcw_peaks_cin, mult="first")$enrichment
  peaks$Zcw_wP9_enrichment <- foverlaps(peaks, zcw_wP9_peaks_cin, mult="first")$enrichment
  peaks$ZcwCVC_enrichment <- foverlaps(peaks, zcw_wP9_vs_chip_Z, mult="first")$enrichment
  
  peaks$H3K4UT_enrichment <- foverlaps(peaks, h3k4me3_UT_peaks, mult="first")$enrichment
  peaks$H3K4P9_enrichment <- foverlaps(peaks, h3k4me3_P9_peaks, mult="first")$enrichment
  peaks$H3K36P9_enrichment <- foverlaps(peaks, h3k36me3_P9_peaks, mult="first")$enrichment
  
  peaks$HP9combo_enrichment <- foverlaps(peaks, HP9combo_peaks, mult="first")$enrichment
  peaks$dmc1_enrichment <- foverlaps(peaks, dmc1, mult="first")$enrichment
  peaks$Alu_score <- foverlaps(peaks,repeats[grep("Alu",Name)], mult="first")$Score #[Name!="Alu"][CI_stop-CI_start>250 & CI_stop-CI_start<350]
  peaks$NonAlu_score <- foverlaps(peaks,repeats[!grep("Alu",Name)], mult="first")$Score
  #peaks$CpGI <- foverlaps(peaks,CGI, mult="first")$V6
  #peaks$H1C_H4K20 <- foverlaps(peaks,H1C_H4K20, mult="first")$V5
  #peaks$setdb1_5 <- foverlaps(peaks,setdb1_5, mult="first")$V7
  
  peaks_QC <- peaks[cov_input>5][chr!="chrX"]
  
  peaks_QC[ , decile := cut(enrichment,
                            breaks = quantile(enrichment, 
                                              probs = seq(0, 1, by = 1/k)),
                            labels = 1:k,
                            include.lowest=T)]
  
  set_matrix <- peaks_QC[order(-enrichment)][,.(
    "Zcw_Alone"=!is.na(zcw_peaks_enrichment),
    "Zcw_wP9"=!is.na(Zcw_wP9_enrichment),
    "Zcw_CVC"=!is.na(ZcwCVC_enrichment),
    
    "H3K4me3_UT"=!is.na(H3K4UT_enrichment),
    "H3K4me3_P9"=!is.na(H3K4P9_enrichment),
    "H3K36me3_P9"=!is.na(H3K36P9_enrichment),
    
    "hP9_Cterm"=!is.na(HP9combo_enrichment),
    "Dmc1"=!is.na(dmc1_enrichment),
    "Alu"=!is.na(Alu_score),
    "NonAlu"=!is.na(NonAlu_score),
    #"CpGI"=!is.na(CpGI),
    #"H1C_H4K20"=!is.na(H1C_H4K20),
    #"Setdb1_5"=!is.na(setdb1_5),
    "total_peaks"=nrow(peaks_QC), #(as.numeric(decile)/k)*nrow(peaks_QC)
    "decile"=as.numeric(decile))]#[!is.na(decile)]*1
  
  if(returnpeaks){
    peaks_QC
  }else{
    return(set_matrix)
  }
}
```

```{r repeats}
repeats <- fread("../data/repeats/Repeat_MaskerSorted.bed")

setnames(repeats, c("chr","CI_start","CI_stop","Name","Score","Strand"))

repeats$id <- seq_along(repeats$chr)

repeats <- prejoin(repeats, ext = 0)

```


```{r proportions_plot, fig.width = 10.5, fig.height = 5}
set_matrix_zcw_peaks <- create_set_matrix(zcw_peaks_cin, k=100)
set_matrix_zcw_peaks$Experiment <- "ZCWPW1 Alone"

set_matrix_zcw_wP9_peaks_cin <- create_set_matrix(zcw_wP9_peaks_cin, k=100)
set_matrix_zcw_wP9_peaks_cin$Experiment <- "ZCWPW1 PRDM9 Cotransfected"

set_matrix_zcw_wP9_vs_chip_Z <- create_set_matrix(zcw_wP9_vs_chip_Z, k=100)
set_matrix_zcw_wP9_vs_chip_Z$Experiment <- "ZCWPW1 PRDM9 Cotransfected vs ZCWPW1 alone"

set_matrix_comb <- rbind(set_matrix_zcw_peaks, set_matrix_zcw_wP9_peaks_cin, set_matrix_zcw_wP9_vs_chip_Z)

set_matrix_comb[,.N,by=c("Zcw_Alone","Zcw_wP9","Zcw_CVC","Experiment")]

proportions <- set_matrix_comb[,.("Not Zcw Alone" = sum(Zcw_Alone==0) / .N,
                             "Zcw Alone, Not hP9, + ut_H3K4" = sum(Zcw_Alone==1 & hP9_Cterm==0 & H3K4me3_UT==1) / .N,
                             "Zcw Alone, Not hP9, + Not ut_H3K4 + NotAlu" = sum(Zcw_Alone==1 & hP9_Cterm==0 & H3K4me3_UT==0 & Alu==0) / .N,
                             "Zcw Alone, Not hP9, + Not ut_H3K4 + Alu" = sum(Zcw_Alone==1 & hP9_Cterm==0 & H3K4me3_UT==0& Alu==1) / .N,
                             "Zcw Alone, + hP9, + p9_H3K4" = sum(Zcw_Alone==1 & hP9_Cterm==1 & H3K4me3_P9==1) / .N,
                             "Zcw Alone, + hP9, + Not p9_H3K4" = sum(Zcw_Alone==1 & hP9_Cterm==1 & H3K4me3_P9==0) / .N
                             ),
                          by=c("decile","Experiment","total_peaks")]


scales_x <- list(
  "ZCWPW1 Alone" = scale_x_continuous(expand=c(0,0), 
    labels = function(x) format((x/100)*unique(set_matrix_zcw_peaks$total_peaks), scientific = T, digits=2)),
  "ZCWPW1 PRDM9 Cotransfected" = scale_x_continuous(expand=c(0,0), 
    labels = function(x) format((x/100)*unique(set_matrix_zcw_wP9_peaks_cin$total_peaks), scientific = T, digits=2)),
  "ZCWPW1 PRDM9 Cotransfected vs ZCWPW1 alone" = scale_x_continuous(expand=c(0,0), 
    labels = function(x) format((x/100)*unique(set_matrix_zcw_wP9_vs_chip_Z$total_peaks), scientific = T, digits=2))
)

tmp <- melt(proportions, id.vars = c("decile","Experiment","total_peaks"), variable.name = "Subset")

#tmp$Experiment <- gsub(" ", "_", tmp$Experiment)
#tmp$Experiment <- as.factor(tmp$Experiment)

proportions_plot <- ggplot(tmp, aes(decile, value, fill=Subset, colour=Subset)) +
  geom_col() + 
  facet_grid_sc(cols=vars(Experiment), scales=list(x=scales_x)) +
  scale_fill_brewer(palette = "Paired") +
  scale_colour_brewer(palette = "Paired") +
  scale_y_continuous(expand=c(0,0)) +
  theme(legend.position = "bottom", axis.text.x=element_text(angle=25, vjust=1, hjust=1)) +
  guides(colour = guide_legend(ncol = 2), fill = guide_legend(ncol = 2)) +
  ylab("Proportion of peaks for a given centile") +
  xlab("Enrichment Ranking")

proportions_plot

#pdf("../results/proportions_plot_v5.pdf", width = 10, height = 5)
#proportions_plot
#dev.off()

UpSetR::upset(set_matrix_zcw_peaks[decile==1][,1:11]*1, nsets = 11)
UpSetR::upset(set_matrix_zcw_peaks[decile==100][,1:11]*1, nsets = 11)
#UpSetR::upset(set_matrix[,c("Zcw_Alone", "hP9_Cterm","Dmc1","decile"),with=F][decile==50])
```

which repeat most enriched in the top decile/ top 10%: "G-rich"

```{r top_decile_enriched}
tmp <- foverlaps(zcw_wP9_peaks_cin,repeats[!grep("Alu",Name)], mult="first")
k=100
tmp[ , decile := cut(enrichment,
                  breaks = quantile(enrichment, 
                                    probs = seq(0, 1, by = 1/k)),
                  labels = 1:k,
                  include.lowest=T)]
tmp[, decile2 := as.numeric(as.character(decile))]

merge(tmp[decile2<10][,.N,by=Name], tmp[decile2>90][,.N,by=Name], by="Name")[,.(Name, N.x,N.y,(N.y+25)/(N.x+25))][order(-V4)][1:10]

ggplot(merge(tmp[decile2<10][,.N,by=Name], tmp[decile2>90][,.N,by=Name], by="Name"), aes(N.x+25,N.y+25)) + geom_point() + scale_x_log10() + scale_y_log10() + geom_abline()

ggplot(merge(tmp[decile==1][,.N,by=Name], tmp[decile2==100][,.N,by=Name], by="Name"), aes(N.x,N.y)) + geom_point() + scale_x_log10() + scale_y_log10() + geom_abline()

ggplot(merge(tmp[decile==1][,.N,by=Name], tmp[decile==100][,.N,by=Name], by="Name"), aes(N.x+25,N.y+25)) + geom_point() + scale_x_log10() + scale_y_log10() + geom_abline()

fraction_overlapN2(zcw_peaks_cin[cov_input>=5], repeats[grep("G-rich",Name)], x1="Zcw UT", y1="G-rich", shift=1e8) + scale_y_continuous()
fraction_overlapN2(zcw_peaks_cin[cov_input>=5], repeats[grep("MER52[A|C|D]",Name)], x1="Zcw UT", y1="MER52A|C|D", shift=1e8) + scale_y_continuous()
```


## Export unexplained peaks

```{r, eval=FALSE}

# chr17 76735902 76737548
# set_matrix_zcw_peaks2 <- create_set_matrix(zcw_peaks_cin, k=1, returnpeaks = T)
# 
# set_matrix_zcw_peaks2[chr=="chr17" && CI_start>76735902 && CI_stop<76737548]
# set_matrix_zcw_peaks2[chr=="chr1" && CI_start>248711913 && CI_stop<248711956]
 
set_matrix_zcw_peaks3 <- create_set_matrix(zcw_peaks_cin, k=1)

fwrite(zcw_peaks_cin[cov_input>5][chr!="chrX"][order(-enrichment)][set_matrix_zcw_peaks3[,which(Zcw_Alone==T & hP9_Cterm==F & H3K4me3_UT==F & Alu==F & H3K36me3_P9==F)]][,.(chr,CI_start, CI_stop)],"Zcw_alone_unexplained.bed", col.names = F, sep="\t")
#224380

fwrite(zcw_peaks_cin[cov_input>5][chr!="chrX"][order(-enrichment)][set_matrix_zcw_peaks3[,which((hP9_Cterm==T | H3K4me3_UT==T | Alu==T | H3K36me3_P9==T))]][,.(chr,CI_start, CI_stop)],"Zcw_alone_explained.bed", col.names = F, sep="\t")
#227573

fwrite(zcw_peaks_cin[cov_input>5][chr!="chrX"][order(-enrichment)][set_matrix_zcw_peaks3[,which(Zcw_Alone==T & hP9_Cterm==F & H3K4me3_UT==F & Alu==F & H3K36me3_P9==F)]][,.(chr, center_start-250, center_stop+250)],"Zcw_alone_unexplained_500w.bed", col.names = F, sep="\t")

fwrite(zcw_peaks_cin[cov_input>5][chr!="chrX"][order(-enrichment)][set_matrix_zcw_peaks3[,which(Zcw_Alone==T & hP9_Cterm==F & H3K4me3_UT==F & Alu==F & H3K36me3_P9==F)]][,.(chr, center_start-500L, center_stop+500L)],"Zcw_alone_unexplained_1000w.bed", col.names = F, sep="\t")

```

## Overlap Hunting

```{r overlap_hunting}


ctcf <- loadBed("../data/ENCODE_beds/ENCFF314ZAL.bed")
ctcf_2 <- loadBed("../data/ENCODE_beds/ENCFF338RAX.bed") # bed narrowPeak	peaks and background as input for IDR	1, 2

# https://www.encodeproject.org/experiments/ENCSR000EUZ/ SE36nt HEK293T
Trim28 <- loadBed("../data/ENCODE_beds/ENCFF860DHS.bed") #, 29k peaks
Trim28_2 <- loadBed("../data/ENCODE_beds/ENCFF959SPJ.bed") #300k
#bed narrowPeak	peaks and background as input for IDR	1, 2

#https://www.encodeproject.org/experiments/ENCSR474CVP/ PE100bp K562
Trim28_3 <- loadBed("../data/ENCODE_beds/ENCFF131RPK.bed") # 300k

#https://www.encodeproject.org/experiments/ENCSR876GXA/ ZBTB33
zbtb33 <- loadBed("../data/ENCODE_beds/ENCFF108BVL.bed")

#https://www.encodeproject.org/experiments/ENCSR142YYA/ EWSR1
ewsr1 <- loadBed("../data/ENCODE_beds/ENCFF418KWK.bed")

h3K27ac <- loadBed("../data/ENCODE_beds/ENCFF451UZW.bed")
h3K27ac_2 <- loadBed("../data/ENCODE_beds/ENCFF464QPC.bed")

# https://www.encodeproject.org/experiments/ENCSR000AKQ/, h3K27me3
h3K27me3 <- loadBed("../data/ENCODE_beds/ENCFF700RBU.bed")

#https://www.encodeproject.org/experiments/ENCSR000FCG/
h3k4me1 <- loadBed("../data/ENCODE_beds/ENCFF483QXH.bed")

# https://www.encodeproject.org/experiments/ENCSR396QWK/ FLAG MBD
# HepG2 genetically modified using CRISPR, SE50nt
mbd1 <- loadBed("../data/ENCODE_beds/ENCFF446OZF.bed")

# https://www.encodeproject.org/experiments/ENCSR221GAN/ K562 MBD2
mbd2 <- loadBed("../data/ENCODE_beds/ENCFF786NME.bed")

# https://www.encodeproject.org/experiments/ENCSR000EVX/ ZNF274
znf274 <- loadBed("../data/ENCODE_beds/ENCFF478NGK.bed")

#https://www.encodeproject.org/experiments/ENCSR987PBI/ DNMT1 K562
dnmt1 <- loadBed("../data/ENCODE_beds/ENCFF129ADK.bed") # 300k peaks

# https://www.encodeproject.org/experiments/ENCSR156CWW/ dnmt3b in HepG2 FLAG tagged, SE52bp
dnmt3b <- loadBed("../data/ENCODE_beds/ENCFF204MYY.bed") # 300k peaks

# https://www.encodeproject.org/experiments/ENCSR000BNK/
ctcfl <- loadBed("../data/ENCODE_beds/ENCFF678TFE.bed") #CTCFL ChIP-seq protocol v041610.1 on human K562 
ctcfl_2 <- loadBed("../data/ENCODE_beds/ENCFF081QMM.bed") #CTCFL bed narrowPeak	peaks and background as input for IDR	1, 2

# hg19
# system("cut -f 1-3 ../data/ENCODE_beds/ENCODE_beds/ENCFF001VRG.bed > ../data/ENCODE_beds/ENCODE_beds/ENCFF001VRG.bed3")
# setdb1 <- loadBed("../data/ENCODE_beds/ENCODE_beds/ENCFF001VRG_hg38.bed3")

# hg38
# https://www.encodeproject.org/experiments/ENCSR000AUT/ SE36nt
setdb1_2 <- loadBed("../data/ENCODE_beds/ENCFF101AKQ.bed") # ENCSR000AUT/ K562 300k peaks, peaks and background as input for IDR	1

# https://www.encodeproject.org/experiments/ENCSR000EWI/ SE32nt
setdb1_3 <- loadBed("../data/ENCODE_beds/ENCFF611CFB.bed") # ENCSR000EWI/ K562 300k peaks, peaks and background as input for IDR	1, 2

h3k9 <- loadBed("../data/ENCODE_beds/ENCFF342JBJ.bed")
H3K9me3 <- loadBed("../data/ENCODE_beds/ENCFF538EDC.bed") # K562, 92k peaks, bed narrowPeak	peaks	1
H3K9me3_2 <- loadBed("../data/ENCODE_beds/ENCFF422AIH.bed") # HEK293, 54k peaks,  bed narrowPeak	peaks	2




CGI <- fread("../data/CpG/cpgIslandExtUnmasked.txt") #CpG
names(CGI)[2:4] <- c("chr","CI_start","CI_stop")
CGI <- prejoin(CGI, ext = 250)

# CpG Binding Proteins MGI
# http://www.informatics.jax.org/marker/summary?nomen=&cm=&coordinate=&coordUnit=bp&startMarker=&endMarker=&go=&goVocab=goFunctionTerm&goVocab=goProcessTerm&goVocab=goComponentTerm&interpro=IPR001739+OR+IPR022056+OR+IPR025884+OR+IPR032343&phenotype=



fraction_overlapN2(zcw_peaks_cin[cov_input>5], zbtb33, "Zcwpw1", "Zbtb33", shift=1e8, n=100) # up to 25, - 12.5
fraction_overlapN2(zcw_peaks_cin[cov_input>5], ewsr1, "Zcwpw1", "ewsr1", shift=1e8, n=100) # depleted down to 6%

fraction_overlapN2(zcw_peaks_cin[cov_input>5], h3K27ac, "Zcwpw1", "h3K27ac", shift=1e8, n=100)
fraction_overlapN2(zcw_peaks_cin[cov_input>5], h3K27ac_2, "Zcwpw1", "h3K27ac", shift=1e8, n=100) # 70k peaks, up to ~15%

fraction_overlapN2(zcw_peaks_cin[cov_input>5], h3K27me3, "Zcwpw1", "h3K27me3", shift=1e8, n=100) # up to %25 then dips
fraction_overlapN2(zcw_peaks_cin[cov_input>5], mbd1, "Zcwpw1", "mbd1", shift=1e8, n=100) # up to ~30%
fraction_overlapN2(zcw_peaks_cin[cov_input>5], mbd2, "Zcwpw1", "mbd2", shift=1e8, n=50) + theme(legend.position = "bottom") # up to ~40%!
fraction_overlapN2(zcw_peaks_cin[cov_input>5], znf274, "Zcwpw1", "znf274", shift=1e8, n=100) # very flat!
fraction_overlapN2(zcw_peaks_cin[cov_input>5], dnmt1, "Zcwpw1", "dnmt1", shift=1e8, n=100) # to ~20%, (flat, PE100bp)
fraction_overlapN2(zcw_peaks_cin[cov_input>5], dnmt3b, "Zcwpw1", "dnmt3b", shift=1e8, n=100) #

fraction_overlapN2(zcw_peaks_cin[cov_input>5], h3k9, "Zcwpw1", "h3k9", shift=1e8, n=100)
fraction_overlapN2(zcw_peaks_cin[cov_input>5], H3K9me3, "Zcwpw1", "H3K9me3", shift=1e8, n=100) # depleted!
fraction_overlapN2(zcw_peaks_cin[cov_input>5], H3K9me3_2, "Zcwpw1", "H3K9me3_2", shift=1e8, n=100) # also depleted!
fraction_overlapN2(zcw_peaks_cin[cov_input>5], H3K9me3_2, "Zcwpw1", "H3K9me3", shift=1e8, n=25) + scale_y_continuous() + theme(legend.position = "bottom")

fraction_overlapN2(zcw_peaks_cin[cov_input>5], setdb1_2, "Zcwpw1", "setdb1", shift=1e8, n=100) + theme(legend.position = "bottom")
fraction_overlapN2(zcw_peaks_cin[cov_input>5], setdb1_3, "Zcwpw1", "setdb1", shift=1e8, n=100) + theme(legend.position = "bottom")

setdb1_2$enrichment <- setdb1_3$V7
fraction_overlapN2(setdb1_2, zcw_peaks_cin, "setdb1_2", "Zcwpw1", shift=1e8, n=100) + theme(legend.position = "bottom")

setdb1_3$enrichment <- setdb1_3$V7
fraction_overlapN2(setdb1_3, zcw_peaks_cin, "setdb1_3", "Zcwpw1", shift=1e8, n=100) + theme(legend.position = "bottom")

fraction_overlapN2(zcw_peaks_cin[cov_input>5], ctcfl, "Zcwpw1", "Ctcfl in K562", shift=1e8, n=100)
fraction_overlapN2(zcw_peaks_cin[cov_input>5], ctcfl_2, "Zcwpw1", "ctcfl_2", shift=1e8, n=100) # up to ~35%, 300k peaks

fraction_overlapN2(zcw_peaks_cin[cov_input>5], ctcf, "Zcwpw1", "ctcf", shift=1e8, n=100)
fraction_overlapN2(zcw_peaks_cin[cov_input>5], ctcf_2, "Zcwpw1", "ctcf", shift=1e8, n=100) # up to 37.5, 300k peaks

fraction_overlapN2(zcw_peaks_cin[cov_input>5], Trim28, "Zcwpw1", "Trim28", shift=1e8, n=100)
fraction_overlapN2(zcw_peaks_cin[cov_input>5], Trim28, "Zcwpw1", "Trim28", shift=1e8, n=25) + scale_y_continuous()
fraction_overlapN2(zcw_peaks_cin[cov_input>5], Trim28_2, "Zcwpw1", "Trim28", shift=1e8, n=50)+ theme(legend.position = "bottom") # SE36nt
fraction_overlapN2(zcw_peaks_cin[cov_input>5], Trim28_3, "Zcwpw1", "Trim28", shift=1e8, n=50)+ theme(legend.position = "bottom") # better at lower enrich (Alu), PE100bp


fraction_overlapN2(zcw_peaks_cin[cov_input>5], CGI, "Zcwpw1", "CpG Islands", shift=1e8, n=100)
fraction_overlapN2(zcw_peaks_cin[cov_input>5], h3k4me1, "Zcwpw1", "h3K4me1", shift=1e8, n=100) # 100k peaks, barely visible enrich




```

# Mappability Masked

```{r mappability_masked}

zcw_peaks_cin_m24 <- fread("../data/mappability/Zcwpw1_peak_cin_24bpmappable.bed")
names(zcw_peaks_cin_m24) <- names(zcw_peaks_cin)[1:11]
zcw_peaks_cin_m24 <- prejoin(zcw_peaks_cin_m24)

fraction_overlapN2(zcw_peaks_cin[cov_input>5], setdb1_3, "Zcwpw1", "setdb1", shift=1e8, n=50) + theme(legend.position = "bottom")
fraction_overlapN2(zcw_peaks_cin_m24[cov_input>5], setdb1_3, "Zcwpw1", "setdb1", shift=1e8, n=50) + theme(legend.position = "bottom")

setdb1_3$enrichment <- setdb1_3$V7

fraction_overlapN2(setdb1_3, zcw_peaks_cin, "Setdb1", "Zcwpw1", shift=1e8, n=50) + theme(legend.position = "bottom")
fraction_overlapN2(setdb1_3, zcw_peaks_cin_m24, "Setdb1", "Zcwpw1", shift=1e8, n=50) + theme(legend.position = "bottom")
```


# H4K20

```{r H3K420}

IPSC_H4K20 <- loadBed("../data/ENCODE_beds/ENCFF295WQL.bed")  #    Homo sapiens GM23338 originated from GM23248 https://www.encodeproject.org/experiments/ENCSR293NAJ/

H1C_H4K20 <- loadBed("../data/ENCODE_beds/ENCFF665UWA.bed") #     Homo sapiens H1 https://www.encodeproject.org/experiments/ENCSR728SZE/

H1C_H4K20_rep <- loadBed("../data/ENCODE_beds/ENCFF439CWL.bed") #     Homo sapiens H1 https://www.encodeproject.org/experiments/ENCSR728SZE/

H9C_H4K20 <- loadBed("../data/ENCODE_beds/ENCFF280SGN.bed") #    Homo sapiens hepatocyte originated from H9 https://www.encodeproject.org/experiments/ENCSR289TGF/
H9CSMO_H4K20 <- loadBed("../data/ENCODE_beds/ENCFF653UGW.bed") #     Homo sapiens smooth muscle cell originated from H9 https://www.encodeproject.org/experiments/ENCSR189XIE/
H9CNP_H4K20 <- loadBed("../data/ENCODE_beds/ENCFF435BYC.bed") # Some,   Homo sapiens neural progenitor cell originated from H9 https://www.encodeproject.org/experiments/ENCSR720ZAX/

IMR90_H4K20 <- loadBed("../data/ENCODE_beds/ENCFF567BLE.bed") # up to 37, Homo sapiens IMR-90 https://www.encodeproject.org/experiments/ENCSR804SRO/

MCF7_H4K20 <- loadBed("../data/ENCODE_beds/ENCFF151LTX.bed") #    Homo sapiens MCF-7, https://www.encodeproject.org/experiments/ENCSR639RHG/
HCT116_H4K20 <- loadBed("../data/ENCODE_beds/ENCFF403LQH.bed") #     Homo sapiens HCT116 https://www.encodeproject.org/experiments/ENCSR474DOV/

KMS11_H4K20 <- loadBed("../data/ENCODE_beds/ENCFF720TFF.bed")  #     Homo sapiens KMS-11 https://www.encodeproject.org/experiments/ENCSR790QWJ/

H1NC_H4K20 <- loadBed("../data/ENCODE_beds/ENCFF108PRX.bed") #Homo sapiens neural cell originated from H1 https://www.encodeproject.org/experiments/ENCSR958ZMM/


fraction_overlapN2(zcw_peaks_cin[cov_input>5], H1C_H4K20, "Zcwpw1", "H1C_H4K20", shift=1e8, n=100) # 12 to 50%
fraction_overlapN2(zcw_peaks_cin[cov_input>5], H1C_H4K20, "Zcwpw1", "H1C_H4K20", shift=1e8, n=50) + theme(legend.position = "bottom")
fraction_overlapN2(zcw_peaks_cin[cov_input>5], H1C_H4K20_rep, "ZcwST", "H1C_H4K20_rep", shift=1e8, n=100) # 5 to 30%

fraction_overlapN2(zcw_peaks_cin[cov_input>5], IMR90_H4K20, "ZcwST", "H9CSMO_H4K20", shift=1e8, n=100) # 10% to 37% enriched

fraction_overlapN2(zcw_peaks_cin[cov_input>5], IPSC_H4K20, "ZcwST", "IPSC_H4K20", shift=1e8, n=100) # flat, but small enrichment

fraction_overlapN2(zcw_peaks_cin[cov_input>5], H9C_H4K20, "ZcwST", "H9C_H4K20", shift=1e8, n=100) # mostly flat, v small enrich
fraction_overlapN2(zcw_peaks_cin[cov_input>5], H9CNP_H4K20, "ZcwST", "H9CNP_H4K20", shift=1e8, n=100) # moderate increase, 10% to ~27%
fraction_overlapN2(zcw_peaks_cin[cov_input>5], H9CSMO_H4K20, "ZcwST", "H9CSMO_H4K20", shift=1e8, n=100) # mostly flat, increase 10 to 27 at high enrich

fraction_overlapN2(zcw_peaks_cin[cov_input>5], MCF7_H4K20, "ZcwST", "MCF7_H4K20", shift=1e8, n=100) # again mostly flat, increase 10 to 27 at high enrich

fraction_overlapN2(zcw_peaks_cin[cov_input>5], HCT116_H4K20, "ZcwST", "HCT116_H4K20", shift=1e8, n=100) # Depleated!

fraction_overlapN2(zcw_peaks_cin[cov_input>5], KMS11_H4K20, "ZcwST", "KMS11_H4K20", shift=1e8, n=100) # Depleated!

fraction_overlapN2(zcw_peaks_cin[cov_input>5], H1NC_H4K20, "ZcwST", "H1NC_H4K20", shift=1e8, n=100) # enriched for high enrichZcw
```

```{r H3K420_other}
fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>5], H1C_H4K20, "ZcwST", "H1C_H4K20", shift=1e8, n=100) # 50

fraction_overlapN2(HP9combo_peaks[cov_input>5], H1C_H4K20, "HP9combo", "H1C_H4K20", shift=1e8, n=100) # 30%

fraction_overlapN2(HP9N_peaks[cov_input>5], H1C_H4K20, "HP9N", "H1C_H4K20", shift=1e8, n=100) # 12 
```


# Rank change with +P9

```{r P9_change, eval=FALSE}
# this chunk required FC_Zcw_enrichment from forcecalling script
HP9combo_peaks$ZcwST_peaks_enrichment <- foverlaps(HP9combo_peaks, zcw_peaks_cin, mult="first")$enrichment

ggplot(HP9combo_peaks[cov_input>5], aes(enrichment, ZcwST_peaks_enrichment)) + geom_point(alpha=0.1, stroke=0)
ggplot(HP9combo_peaks[cov_input>5], aes(rank(enrichment), rank(ZcwST_peaks_enrichment))) + geom_point(alpha=0.1, stroke=0)

ggplot(HP9combo_peaks[cov_input>5], aes(rank(enrichment), rank(FC_Zcw_enrichment))) + geom_point(alpha=0.1, stroke=0)

ggplot(HP9combo_peaks[cov_input>5], aes(rank(enrichment), rank(FC_Zcw_wP9_enrichment))) + geom_point(alpha=0.1, stroke=0)

ggplot(HP9combo_peaks[cov_input>5], aes(rank(enrichment), rank(FC_Zcw_CVC_enrichment))) + geom_point(alpha=0.1, stroke=0)
```




# HP9HA_C vs HP9V5_C

HA C is a subset of V5 C

```{r HP9HA_C_vs_HP9V5_C}
fraction_overlapN2(HP9V5_peaks[cov_input>6], HP9_peaks, "hPrdm9V5", "hPrdm9HA", shift=1e5) 
fraction_overlapN2(HP9_peaks[cov_input>6], HP9V5_peaks, "hPrdm9HA", "hPrdm9V5", shift=1e5)

HP9V5_peaks$HP9_enrichment <- foverlaps(HP9V5_peaks, HP9_peaks, mult="first")$enrichment
plot(HP9V5_peaks[cov_input>5]$enrichment, HP9V5_peaks[cov_input>5]$HP9_enrichment, log='xy', pch='.')
cor(HP9V5_peaks[cov_input>5][!is.na(HP9_enrichment)]$enrichment, HP9V5_peaks[cov_input>5][!is.na(HP9_enrichment)]$HP9_enrichment)
```

## Cterm Combo vs V5, HA

```{r Cterm_combo_vs_V5_&_HA}
fraction_overlapN2(HP9combo_peaks[cov_input>5], HP9V5_peaks,  "hPrdm9 Cterm combo", "hPrdm9 Cterm V5", shift=1e5)
fraction_overlapN2(HP9combo_peaks[cov_input>5], HP9_peaks,  "hPrdm9 Cterm combo", "hPrdm9 Cterm HA", shift=1e5)
```


# P9 N vs C term

~ 60% overlap in both directions

```{r P9_N_vs_C}
fraction_overlapN2(HP9N_peaks[cov_input>5], HP9combo_peaks, "hPrdm9 Nterm", "hPrdm9 Cterm", shift=1e5)
fraction_overlapN2(HP9combo_peaks[cov_input>5], HP9N_peaks,  "hPrdm9 Cterm", "hPrdm9 Nterm", shift=1e5)

# HP9N_peaks$HP9_enrichment <- foverlaps(HP9N_peaks, HP9_peaks, mult="first")$enrichment
HP9N_peaks$HP9combo_enrichment <- foverlaps(HP9N_peaks, HP9combo_peaks, mult="first")$enrichment
# HP9combo_peaks$HP9N_enrichment <- foverlaps(HP9combo_peaks, HP9N_peaks, mult="first")$enrichment
# 
# plot(HP9N_peaks[cov_input>5]$enrichment, HP9N_peaks[cov_input>5]$HP9_enrichment, log='xy', pch='.')
# plot(HP9N_peaks[cov_input>5]$enrichment, HP9N_peaks[cov_input>5]$HP9combo_enrichment, log='xy', pch='.')
# cor(HP9N_peaks[cov_input>5][!is.na(HP9_enrichment)]$enrichment, HP9N_peaks[cov_input>5][!is.na(HP9_enrichment)]$HP9_enrichment)
```

```{r upset, eval=FALSE}
# need to join these enrichments to eval this chunk
UpSetR::upset(HP9N_peaks[,.("Nterm P9"=!is.na(chr),
                            "Cterm HA & V5"=!is.na(HP9combo_enrichment),
                            "C term HA"=!is.na(HP9_enrichment),
                            "P9 H3K4me3"=!is.na(h3k4me3_P9_enrichment),
                            "UT H3K4me3"=!is.na(h3k4me3_UT_enrichment),
                            "Zcw CVC"=!is.na(zcw_CVC_enrichment),
                            "Zcw wP9_cin"=!is.na(zcw_wP9_cin_enrichment),
                            "Zcw"=!is.na(zcw_enrichment))]*1,
              nsets = 8)

UpSetR::upset(dmc1[,.("Nterm P9"=!is.na(HP9N_peaks_enrichment),
                            "Cterm HA & V5"=!is.na(HP9combo_peaks_enrichment),
                            #"Zcw CVC"=!is.na(zcw_CVC_enrichment),
                            "Zcw wP9_cin"=!is.na(zcw_wP9_cin_enrichment),
                            "Zcw"=!is.na(zcw_enrichment))]*1,
              nsets = 4)
```


## Visualise Similar N & C term peaks

```{r NC_similar}
HP9N_peaks[,NC_similar := (HP9combo_enrichment/enrichment)>exp(0.2*enrichment^1.5) | HP9combo_enrichment/enrichment<exp(-0.2*HP9combo_enrichment^1.5)]

ggplot(HP9N_peaks[cov_input>5], aes(enrichment, HP9combo_enrichment,
                                    colour=NC_similar)) +
  geom_point(pch='.', size=0.1) +
  scale_x_log10() + scale_y_log10() +
  theme(legend.position = 'bottom') + 
  geom_abline(intercept = 0,slope = 1)
```


```{r NC_similar_force, eval=FALSE}
# need to join FC_hP9combo_enrichment for this chunk
HP9N_peaks[,NC_similar := (FC_hP9combo_enrichment/enrichment)>exp(0.2*enrichment^1.5) | FC_hP9combo_enrichment/enrichment<exp(-0.2*FC_hP9combo_enrichment^1.5)]

ggplot(HP9N_peaks[cov_input>5], aes(enrichment, FC_hP9combo_enrichment,
                                    colour=NC_similar)) +
  geom_point(pch='.', size=0.1) +
  scale_x_log10() + scale_y_log10() +
  theme(legend.position = 'bottom') + 
  geom_abline(intercept = 0,slope = 1)

rr=rank(HP9N_peaks$enrichment)
rr2=rank(HP9N_peaks$FC_hP9combo_enrichment)
cor(rr,rr2)
# [1] 0.3245829
rr=rr/length(rr)
rr2=rr2/length(rr2)

similar_rank=abs(rr-rr2)<0.1
mean(similar_rank)

quantile(abs(rr-rr2),1/3)
#33.33333% 
#0.1302969 
similar_rank=abs(rr-rr2)<0.1303

similar_rank=abs(rr-rr2)<0.05

ggplot(HP9N_peaks[cov_input>5], aes(enrichment, FC_hP9combo_enrichment, colour=similar_rank[HP9N_peaks$cov_input>5])) +
  geom_point(pch='.', size=0.1) +
  scale_x_log10() + scale_y_log10() +
  theme(legend.position = 'bottom') + 
  geom_abline(intercept = 0,slope = 1)

```


```{r H3K4me3_vs_HP9N}
h3k4me3_UT_peaks$HP9N_enrichment <- foverlaps(h3k4me3_UT_peaks, HP9N_peaks, mult="first")$enrichment
h3k4me3_P9_peaks$HP9N_enrichment <- foverlaps(h3k4me3_P9_peaks, HP9N_peaks, mult="first")$enrichment
h3k4me3_P9_peaks$HP9N_cov_input <- foverlaps(h3k4me3_P9_peaks, HP9N_peaks, mult="first")$cov_input

fraction_overlapN(h3k4me3_UT_peaks[cov_input>=5], "h3k4me3_UT_peaks", "HP9N_enrichment")
fraction_overlapN(h3k4me3_P9_peaks[cov_input>=5], "h3k4me3_P9_peaks", "HP9N_enrichment")

```

# Chimp vs Human

```{r chimp_vs_human}

# CoT
fraction_overlapN2(zcw_wP9_peaks_cin[cov_input>5], zcw_wcP9_peaks_cin, "Zcw+hP9", "Zcw+cP9", shift=1e8)
fraction_overlapN2(zcw_wcP9_peaks_cin[cov_input>5], zcw_wP9_peaks_cin, "Zcw+cP9", "Zcw+hP9", shift=1e8)

# CVC
fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>5], zcw_wcP9_vs_chip_Z, "ZcwCVChuman", "ZcwCVCchimp", shift=1e8)
fraction_overlapN2(zcw_wcP9_vs_chip_Z[cov_input>5], zcw_wP9_vs_chip_Z, "ZcwCVCchimp", "ZcwCVChuman", shift=1e8)

# P9
fraction_overlapN2(HP9combo_peaks[cov_input>5], CP9combo_peaks, "HP9combo", "CP9combo", shift=1e8)
fraction_overlapN2(CP9combo_peaks[cov_input>5], HP9combo_peaks, "HP9combo", "CP9combo", shift=1e8)


# P9 vs CoT
fraction_overlapN2(HP9combo_peaks[cov_input>5], zcw_wP9_peaks_cin, "HP9combo", "Zcw+hP9", shift=1e8)
fraction_overlapN2(HP9combo_peaks[cov_input>5], zcw_wcP9_peaks_cin, "HP9combo", "Zcw+cP9", shift=1e8)

fraction_overlapN2(CP9combo_peaks[cov_input>5], zcw_wP9_peaks_cin, "CP9combo", "Zcw+hP9", shift=1e8)
fraction_overlapN2(CP9combo_peaks[cov_input>5], zcw_wcP9_peaks_cin, "CP9combo", "Zcw+cP9", shift=1e8)


# P9 vs CVC
fraction_overlapN2(HP9combo_peaks[cov_input>5], zcw_wP9_vs_chip_Z, "HP9combo", "humanZcwCVC", shift=1e8) # up to 75%, even with n=100
fraction_overlapN2(HP9combo_peaks[cov_input>5], zcw_wcP9_vs_chip_Z, "HP9combo", "chimpZcwCVC", shift=1e8) # 0

fraction_overlapN2(CP9combo_peaks[cov_input>5], zcw_wP9_vs_chip_Z, "CP9combo", "humanZcwCVC", shift=1e8)
fraction_overlapN2(CP9combo_peaks[cov_input>5], zcw_wcP9_vs_chip_Z, "CP9combo", "chimpZcwCVC", shift=1e8)

# CVC vs P9
fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>5], HP9combo_peaks,   "humanZcwCVC",  "HP9combo", shift=1e8) # ~ 90%
fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>5], CP9combo_peaks,   "humanZcwCVC",  "CP9combo", shift=1e8) # depleated, close to 0


fraction_overlapN2(zcw_wcP9_vs_chip_Z[cov_input>5], CP9combo_peaks, "chimpZcwCVC",  "CP9combo", shift=1e8) # ~ 80%
fraction_overlapN2(zcw_wcP9_vs_chip_Z[cov_input>5], HP9combo_peaks, "chimpZcwCVC",  "HP9combo", shift=1e8) # still enriched at 50%....



```


# HP9 vs H3K4

Higher hP9combo -> higher overlap with P9 H3K4me3

Higher hP9combo -> lower overlap with UT H3K4me3,
  But still higher than background overlap, so even strong C term Prdm9 locations are near promoters (matches with GC rich regions).


```{r HP9_vs_H3K4me3}
fraction_overlapN2(HP9combo_peaks[cov_input>=5], h3k4me3_UT_peaks, x1="HP9combo", y1="h3k4me3_UT")
fraction_overlapN2(HP9combo_peaks[cov_input>=5][is.na(tss)], h3k4me3_UT_peaks, x1="HP9combo", y1="h3k4me3_UT")
fraction_overlapN2(HP9combo_peaks[cov_input>=5], h3k4me3_P9_peaks, x1="HP9combo", y1="h3k4me3_P9")
fraction_overlapN2(HP9combo_peaks[cov_input>=5][is.na(tss)], h3k4me3_P9_peaks, x1="HP9combo", y1="h3k4me3_P9")
```

Better than C term

higher enriched N peaks, overlap more with transfected H3K4, 
  but less with untransfected H3K4
  

```{r HP9N_vs_H3K4me3}
fraction_overlapN2(HP9N_peaks[cov_input>=5], h3k4me3_UT_peaks, x1="HP9N", y1="h3k4me3_UT")
fraction_overlapN2(HP9N_peaks[cov_input>=5][is.na(tss)], h3k4me3_UT_peaks, x1="HP9N -TSS", y1="h3k4me3_UT")
fraction_overlapN2(HP9N_peaks[cov_input>=5], h3k4me3_P9_peaks, x1="HP9N", y1="h3k4me3_P9")
fraction_overlapN2(HP9N_peaks[cov_input>=5][is.na(tss)], h3k4me3_P9_peaks, x1="HP9N -TSS", y1="h3k4me3_P9")
```



# HP9 vs H3K36me3

```{r HP9_vs_H3K36me3}
fraction_overlapN2(HP9N_peaks[cov_input>=5], h3k36me3_P9_peaks, x1="HP9N", y1="h3k36me3_P9")
fraction_overlapN2(HP9N_peaks[cov_input>=5], h3k36me3_UT_peaks, x1="HP9N", y1="h3k36me3_UT")
```


# HP9 vs Zcw

Most (75%) P9combo peaks in Zcw preexisting (-ve cor???) & Zcw+P9

Nice variation from 0.1 to 0.6 with Chip vs Chip comparison

Less linear Variation with Chip vs Chip for N term, only goes to 25%, similar number of peaks.

```{r HP9_vs_Zcw}
fraction_overlapN2(HP9combo_peaks[cov_input>=5], zcw_peaks_cin, x1="hPrdm9 Cterm combined", y1="Zcw UT", shift = 1e9)
fraction_overlapN2(HP9combo_peaks[cov_input>=5], zcw_wP9_peaks_cin, x1="hPrdm9 Cterm combined", y1="Zcw wP9", shift = 1e9)
fraction_overlapN2(HP9combo_peaks[cov_input>=5], zcw_wP9_vs_chip_Z, x1="hPrdm9 Cterm combined", y1="Zcw CVC", shift = 1e9)

```

```{r CP9_vs_Zcw}
fraction_overlapN2(CP9combo_peaks[cov_input>=5], zcw_peaks_cin, x1="cPrdm9 Cterm combined", y1="Zcw UT", shift = 1e9)
fraction_overlapN2(CP9combo_peaks[cov_input>=5], zcw_wcP9_peaks_cin, x1="cPrdm9 Cterm combined", y1="Zcw wP9", shift = 1e9)
fraction_overlapN2(CP9combo_peaks[cov_input>=5], zcw_wcP9_vs_chip_Z, x1="cPrdm9 Cterm combined", y1="Zcw CVC", shift = 1e9)

```

```{r HP9N_vs_Zcw}
fraction_overlapN2(HP9N_peaks[cov_input>=5], zcw_peaks_cin, x1="hPrdm9 Nterm", y1="Zcw UT", shift = 1e9)
fraction_overlapN2(HP9N_peaks[cov_input>=5], zcw_wP9_peaks_cin, x1="hPrdm9 Nterm", y1="Zcw wP9", shift = 1e9)
fraction_overlapN2(HP9N_peaks[cov_input>=5], zcw_wP9_vs_chip_Z, x1="hPrdm9 Nterm", y1="Zcw CVC", shift = 1e9)

```



# DMC1 vs HP9

Best HP9combo peaks, overlap DMC 15% of the time

~40% of DMC1 overlap HP9combo (30%-60%)


```{r dmc1}
dmc1 <- trim_peaks(dmc1, 800)

plot(dmc1$enrichment, dmc1$width, log="x", pch=".", ylim=c(800,3e3))

plot(HP9N_peaks[cov_input>=5]$enrichment, 
     HP9N_peaks[cov_input>=5][,.(CI_stop-CI_start)]$V1, log="x", pch=".")
```


```{r dmc1_vs_HP9}
fraction_overlapN2(HP9combo_peaks[cov_input>=5],  dmc1, x1="hP9 Cterm combo", y1="Dcm1")
fraction_overlapN2(dmc1, HP9combo_peaks, x1="Dcm1", y1="hP9 Cterm combo")
```

Much cleaner than C term!

Best HP9N peaks overlap DMC1 50% of the time (vs 15%)

~60% of DMC1 overlap HP9N (vs 40%)

```{r HP9N_vs_dmc1}
fraction_overlapN2(HP9N_peaks[cov_input>=5], dmc1, x1="HP9 N term", y1="Dcm1")
fraction_overlapN2(HP9N_peaks[cov_input>=5], dmc1, x1="HP9 N term", y1="Dcm1", n=75)
fraction_overlapN2(HP9N_peaks[cov_input>=5], dmc1, x1="HP9 N term", y1="Dcm1", n=150)
fraction_overlapN2(dmc1, HP9N_peaks, x1="Dcm1", y1="HP9 N term")

```

```{r HP9N_sansH3K4me3_vs_dmc1}
#fraction_overlapN2(HP9N_peaks[cov_input>=5  & FC_h3k4me3_UT_enrichment>1], dmc1, x1="HP9 N term", y1="Dcm1")

HP9N_peaks$h3k4me3_UT_enrichment <- foverlaps(HP9N_peaks, h3k4me3_UT_peaks, mult="first")$enrichment

fraction_overlapN2(HP9N_peaks[cov_input>=5  & !is.na(h3k4me3_UT_enrichment)], dmc1, x1="HP9 N term", y1="Dcm1") + ggtitle("With H3K4 UT enrichment")
fraction_overlapN2(HP9N_peaks[cov_input>=5  & is.na(h3k4me3_UT_enrichment)], dmc1, x1="HP9 N term", y1="Dcm1") + ggtitle("Without H3K4 UT enrichment")
```


```{r HP9C_vs_dmc1}
#fraction_overlapN2(HP9combo_peaks[cov_input>=5  & FC_h3k4me3_UT_enrichment>1], dmc1, x1="HP9 N term", y1="Dcm1")
#fraction_overlapN2(HP9combo_peaks[cov_input>=5  & FC_h3k4me3_UT_enrichment<1], dmc1, x1="HP9 N term", y1="Dcm1")

HP9combo_peaks$h3k4me3_UT_enrichment <- foverlaps(HP9combo_peaks, h3k4me3_UT_peaks, mult="first")$enrichment

fraction_overlapN2(HP9combo_peaks[cov_input>=5  & is.na(h3k4me3_UT_enrichment)], dmc1, x1="HP9 N term", y1="Dcm1")
```


# Zcw vs DMC1

V. few (1%) preexising Zcw become DMC1, but over 50% DMC1 have pre-existing Zcw peaks

V. few (1%, though up to 5%) wP9cotransfected Zcw become DMC1, but 50%+ DMC1 are Zcw_wP9 peaks

Up to 20% of Zcw_CVC peaks become DMC1, Similar fraction of DMC1 have Zcw_CVC peaks


```{r zcw_vs_dmc1}

fraction_overlapN2(zcw_peaks_cin[cov_input>=5], dmc1, x1="Zcw UT", y1="Dcm1", shift = 1e8, n=100)
fraction_overlapN2(zcw_peaks_cin[cov_input>=5], dmc1, x1="Zcw UT", y1="Dcm1", shift = 1e8, n=100) + ylim(0,0.05)
fraction_overlapN2(dmc1, zcw_peaks_cin, x1="Dcm1", y1="Zcw UT", shift = 1e8)

fraction_overlapN2(zcw_wP9_peaks_cin[cov_input>=5],  dmc1, x1="Zcw wP9", y1="Dcm1", shift = 1e8, n=100)
fraction_overlapN2(zcw_wP9_peaks_cin[cov_input>=5],  dmc1, x1="Zcw wP9", y1="Dcm1", shift = 1e8, n=500) + ylim(0,0.25)
fraction_overlapN2(dmc1, zcw_wP9_peaks_cin, x1="Dcm1", y1="Zcw wP9", shift = 1e8)

fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>=5], dmc1, x1="Zcw CVC", y1="Dcm1", shift = 1e8)
fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>=5], dmc1, x1="Zcw CVC", y1="Dcm1", shift = 1e8, n=100)
fraction_overlapN2(dmc1, zcw_wP9_vs_chip_Z, x1="Dcm1", y1="Zcw CVC", shift = 1e8)

```

```{r zcw_vs_dmc1_B}
fraction_overlapN2(zcw_wP9_peaks_cin[cov_input>=5],  dmc1, x1="Zcw wP9", y1="Dcm1", shift = 1e8, n=300)
```


Zcw UT peaks cover 32% of the genome (accounting for width of DMC1 peaks @ 500bp)

```{r mean_zcw_dmc1}
sum(zcw_peaks_cin[,CI_stop_ext-CI_start_ext])/3e9
sum(zcw_peaks_cin[,(CI_stop_ext+250)-(CI_start_ext-250)])/3e9
sum(zcw_peaks_cin[,(CI_stop_ext+400)-(CI_start_ext-400)])/3e9
sum(dmc1[,CI_stop_ext-CI_start_ext])/3e9

hist(dmc1[,CI_stop-CI_start], breaks=100)
mean(dmc1[,CI_stop_ext-CI_start_ext])
```


# Zcw vs HP9

~20% pre-existing Zcw turn into HP9combo peaks, up to 40% for strongest pre-existing peaks

Overall 15% of Zcw_wP9 peaks are H9combo peaks, but up to 90% for strongest Zcw_wP9!

Almost 80% of Zcw_CVC peaks are H9combo peaks

94.2% of the top 3378+3377=6755 peaks overlap H9Combo peaks

```{r zcw_vs_HP9}
fraction_overlapN2(zcw_peaks_cin[cov_input>8], HP9combo_peaks, x1="Zcw UT", y1="hP9 Cterm combo", shift = 1e8)
fraction_overlapN2(zcw_wP9_peaks_cin[cov_input>8], HP9combo_peaks, x1="Zcw wP9", y1="hP9 Cterm combo", n=50, shift = 1e8)
fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>=8], HP9combo_peaks, x1="Zcw CVC", y1="hP9 Cterm combo", shift = 1e7) + ylim(0,1)

zcw_wP9_peaks_cin$HP9combo_enrichment <- foverlaps(zcw_wP9_peaks_cin, HP9combo_peaks, mult="first")$enrichment
1-mean(is.na(zcw_wP9_peaks_cin[cov_input>8][order(-enrichment)][1:10000]$HP9combo_enrichment))
1-mean(is.na(zcw_wP9_peaks_cin[cov_input>8][order(-enrichment)][1:3000]$HP9combo_enrichment))

tmp <- fraction_overlapN2(zcw_wP9_peaks_cin[cov_input>8], HP9combo_peaks, x1="Zcw wP9", y1="hP9 Cterm combo", n=100, shift = 1e8, returndf = T)
mean(tmp[Type=="Randomised"][98:100]$Overlap)

zcw_peaks_cin$HP9combo_enrichment <- foverlaps(zcw_peaks_cin, HP9combo_peaks, mult="first")$enrichment
1-mean(is.na(zcw_peaks_cin[cov_input>8][order(-enrichment)][1:3000]$HP9combo_enrichment))
```


Chimp

```{r zcw_vs_CP9}
fraction_overlapN2(zcw_wcP9_peaks_cin[cov_input>8], CP9combo_peaks, x1="Zcw wcP9", y1="cP9 Cterm combo", n=50, shift = 1e8)
fraction_overlapN2(zcw_wcP9_vs_chip_Z[cov_input>=8], CP9combo_peaks, x1="Zcw CVC", y1="cP9 Cterm combo", shift = 1e7)
```


## Export Zcw_CVC peaks that don't overlap hP9combo peaks

```{r}

zcw_wP9_vs_chip_Z$HP9combo_enrichment <- foverlaps(zcw_wP9_vs_chip_Z, HP9combo_peaks, mult="first")$enrichment
mean(is.na(zcw_wP9_vs_chip_Z$HP9combo_enrichment))

fwrite(zcw_wP9_vs_chip_Z[is.na(HP9combo_enrichment)][order(enrichment)][,.(chr, center_start, center_stop, enrichment)], "../data/other/Zcw_CVC_NonOverlapping_HP9combo_peaks.bed", col.names = FALSE, sep = "\t")
fwrite(zcw_wP9_vs_chip_Z[!is.na(HP9combo_enrichment)][order(enrichment)][,.(chr, center_start, center_stop, enrichment)], "../data/other/Zcw_CVC_Overlapping_HP9combo_peaks.bed", col.names = FALSE, sep = "\t")
```

## Nterm

In all cases worse than combo peaks

~25% pre-existing Zcw turn into HP9N peaks (less than combo), up to 30% for strongest pre-existing peaks

Overall 15-20% of Zcw_wP9 peaks are H9N peaks, but up to 80% for strongest Zcw_wP9 (less than combo)

Almost 80% of Zcw_CVC peaks are H9N peaks (less than combo), direction *opposite* ??


```{r Zcw_vs_NP9N}
fraction_overlapN2(zcw_peaks_cin[cov_input>8], HP9N_peaks, x1="Zcw UT", y1="HP9 N term", shift=1e8)
fraction_overlapN2(zcw_wP9_peaks_cin[cov_input>10], HP9N_peaks, x1="Zcw wP9", y1="HP9 N term", n=50, shift=1e8)
fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>=9], HP9N_peaks, x1="Zcw CVC", y1="HP9 N term", shift=1e7)
```

```{r Zcw_vs_NP9N_diff_ext}
HP9N_peaks <- prejoin(HP9N_peaks, ext=500)
fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>=9], HP9N_peaks, x1="Zcw CVC", y1="HP9 N term 500", shift=1e7) + ylim(0,1)
HP9N_peaks <- prejoin(HP9N_peaks, ext=500)
fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>=9], HP9N_peaks, x1="Zcw CVC", y1="HP9 N term 500", shift=1e7, corrected = T) + ylim(0,1)
HP9N_peaks <- prejoin(HP9N_peaks, ext=300)
fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>=9], HP9N_peaks, x1="Zcw CVC", y1="HP9 N term 300", shift=1e7, corrected = T) + ylim(0,1)
HP9N_peaks <- prejoin(HP9N_peaks, ext=200)
fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>=9], HP9N_peaks, x1="Zcw CVC", y1="HP9 N term 200", shift=1e7, corrected = T) + ylim(0,1)
HP9N_peaks <- prejoin(HP9N_peaks, ext=100)
fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>=9], HP9N_peaks, x1="Zcw CVC", y1="HP9 N term 100", shift=1e7, corrected = T) + ylim(0,1)
# reset, although not actually used after this point
HP9N_peaks <- prejoin(HP9N_peaks)
```


# Zcw vs Zcw

Most (80%) Pre-existing Zcw peaks, are also Zcw_wP9 peaks (<50% for the weakest)

Most (>90%) Zcw_wP9 peaks are pre-existing Zcw, trends less with higher Zcw_wP9 enrichment

Overall few (5%) Zcw_CVC peaks are Zcw_wP9, but up to 80% for highest enriched Zcw_CVC

Most (90%) Zcw_CVC peaks, are Zcw_wP9 peaks (almost logically nececcary?)

```{r zcw_vs_zcw}

fraction_overlapN2(zcw_peaks[cov_input>=5], zcw_wP9_peaks_cin, x1="Zcw UT", y1="Zcw wP9", shift=1e8)

fraction_overlapN2(zcw_wP9_peaks_cin[cov_input>=5], zcw_peaks, x1="Zcw_wP9_cin", y1="zcw_enrichment", shift=1e8)

fraction_overlapN2(zcw_wP9_peaks_cin[cov_input>=5], zcw_wP9_vs_chip_Z, x1="Zcw_wP9_cin", y1="zcw_CVC_enrichment", shift=1e8)
fraction_overlapN2(zcw_wP9_peaks_cin[cov_input>=5], zcw_wP9_vs_chip_Z, x1="Zcw_wP9_cin", y1="zcw_CVC_enrichment",n=200, shift=1e8)

fraction_overlapN2(zcw_wP9_vs_chip_Z[cov_input>5], zcw_wP9_peaks_cin, x1="Zcw_CVC", y1="zcw_wP9_enrichment", shift=1e8)
```



# Zcw vs H3K4

Pre-existing Zcw overlap P9_H3K4me3 5% to 25%

P9 Co-transfected Zcw overlap P9_H3K4me3 10% of the time, up to 70%

Pre-existing Zcw & P9 Co-transfected overlap UT_H3K4me3 < 5%/10% of the time in any case

```{r zcw_vs_H3K4}
#h3k4me3_P9_peaks <- prejoin(h3k4me3_P9_peaks, ext=300)
fraction_overlapN2(zcw_peaks[cov_input>=5], h3k4me3_P9_peaks, x1="Zcw UT", y1="h3k4me3_P9_peaks", shift=1e8)
fraction_overlapN2(zcw_wP9_peaks[cov_input>=5], h3k4me3_P9_peaks, x1="Zcw wP9", y1="h3k4me3_P9_peaks", shift=1e8)
fraction_overlapN2(zcw_wP9_peaks[cov_input>=5], h3k4me3_P9_peaks, x1="Zcw wP9", y1="h3k4me3_P9_peaks", shift=1e8, n=200)
mean(fraction_overlapN2(zcw_wP9_peaks[cov_input>=5], h3k4me3_P9_peaks, x1="Zcw wP9", y1="h3k4me3_P9_peaks", shift=1e8, n=200, returndf = T)[Type=="Randomised"]$Overlap)

fraction_overlapN2(zcw_peaks[cov_input>=5], h3k4me3_UT_peaks, x1="Zcw UT", y1="h3k4me3_UT_peaks", shift=1e8)
fraction_overlapN2(zcw_wP9_peaks[cov_input>=5], h3k4me3_UT_peaks, x1="Zcw wP9", y1="h3k4me3_UT_peaks", shift=1e8)
fraction_overlapN2(zcw_wP9_peaks[cov_input>=5], h3k4me3_UT_peaks, x1="Zcw wP9", y1="h3k4me3_UT_peaks", shift=1e8, n=200)
mean(fraction_overlapN2(zcw_wP9_peaks[cov_input>=5], h3k4me3_UT_peaks, x1="Zcw wP9", y1="h3k4me3_UT_peaks", shift=1e8, n=200, returndf = T)[Type=="Randomised"]$Overlap)
```

```{r H3K4me3}
plot(density(log(h3k4me3_P9_peaks$enrichment)))
lines(density(log(h3k4me3_UT_peaks$enrichment)), col="red")
```


# Zcw vs H3K36

```{r zvw_vs_H3K36}
fraction_overlapN2(zcw_peaks[cov_input>=5], h3k36me3_P9_peaks, x1="Zcw UT", y1="h3k36me3_P9_peaks", shift=1e8)
fraction_overlapN2(zcw_wP9_peaks[cov_input>=5], h3k36me3_P9_peaks, x1="Zcw wP9", y1="h3k36me3_P9_peaks", shift=1e8)

fraction_overlapN2(zcw_peaks[cov_input>=5], h3k36me3_UT_peaks, x1="Zcw UT", y1="h3k36me3_UT_peaks", shift=1e8)
fraction_overlapN2(zcw_wP9_peaks[cov_input>=5], h3k36me3_UT_peaks, x1="Zcw wP9", y1="h3k36me3_UT_peaks", shift=1e8)
```

```{r histone_correlation, fig.width=10}
p1 <- fraction_overlapN2(zcw_wP9_peaks_cin[cov_input>=5], h3k4me3_P9_peaks, x1="Zcw wP9", y1="h3k4me3_P9_peaks", shift=1e8, n=100) +
  ylab("Fraction of ZCWPW1 with PRDM9 peaks \n that overlap H3K4me3 with PRDM9 Peaks") +
  xlab("Mean Enrichment of ZCWPW1 cotransfected with PRDM9") +
  theme(legend.position = "bottom")

p2 <- fraction_overlapN2(zcw_wP9_peaks_cin[cov_input>=5], h3k36me3_P9_peaks, x1="Zcw wP9", y1="h3k36me3_P9_peaks", shift=1e8, n=100) +
  ylab("Fraction of ZCWPW1 with PRDM9 peaks \n that overlap H3K36me3 with PRDM9 Peaks") +
  xlab("Mean Enrichment of ZCWPW1 cotransfected with PRDM9") +
  scale_y_continuous() +
  theme(legend.position = "bottom")

#pdf("../results/Histone_correlation.pdf", width=10)
plot_grid(p1, p2, nrow=1)
#dev.off()
```

# New

```{r hex_plot, fig.width=6}

zcw_wP9_peaks_cin$zcw_peaks_enrichment <- foverlaps(zcw_wP9_peaks_cin, zcw_peaks_cin, mult="first")$enrichment

ggplot(zcw_wP9_peaks_cin[order(-HP9combo_enrichment)], (aes(zcw_peaks_enrichment, enrichment, colour=log(HP9combo_enrichment)))) +
  geom_point(stroke=0, size=1) +
  scale_color_viridis_c()

ggplot(zcw_wP9_peaks_cin, (aes(zcw_peaks_enrichment, enrichment))) +
  geom_hex(bins=100) +
  scale_x_log10() +
  scale_y_log10()

```


# Orientation correlation

```{r orientation_corr}
HP9combo_peaks$zcw_CVC_center_start <- foverlaps(HP9combo_peaks, zcw_wP9_peaks_cin, mult="first")$center_start
HP9combo_peaks$h3k4me3_P9_center_start <- foverlaps(HP9combo_peaks, h3k4me3_P9_peaks, mult="first")$center_start
HP9combo_peaks$h3k36me3_P9_center_start <- foverlaps(HP9combo_peaks, h3k36me3_P9_peaks, mult="first")$center_start

HP9combo_peaks[,dist_to_zcwCVC := center_start - zcw_CVC_center_start]
HP9combo_peaks[,dist_to_h3k4me3 := center_start - h3k4me3_P9_center_start]
HP9combo_peaks[,dist_to_h3k36me3 := center_start - h3k36me3_P9_center_start]

plot(HP9combo_peaks$dist_to_zcwCVC, HP9combo_peaks$dist_to_h3k4me3, pch=".")
cor(HP9combo_peaks$dist_to_zcwCVC, HP9combo_peaks$dist_to_h3k4me3, use="complete.obs")
cor(HP9combo_peaks$dist_to_zcwCVC, HP9combo_peaks$dist_to_h3k36me3, use="complete.obs")

cor(HP9combo_peaks[!is.na(tss)]$dist_to_zcwCVC, HP9combo_peaks[!is.na(tss)]$dist_to_h3k4me3, use="complete.obs")
cor(HP9combo_peaks[is.na(tss)]$dist_to_zcwCVC, HP9combo_peaks[is.na(tss)]$dist_to_h3k4me3, use="complete.obs")
#cor(HP9combo_peaks[FC_h3k4me3_UT_enrichment<1]$dist_to_zcwCVC, HP9combo_peaks[FC_h3k4me3_UT_enrichment<1]$dist_to_h3k4me3, use="complete.obs")

ggplot(HP9combo_peaks, aes(dist_to_zcwCVC, dist_to_h3k4me3)) + geom_point(stroke=0, alpha=0.2, size=0.6) + xlim(-500,500) + ylim(-500,500)

ggplot(HP9combo_peaks[is.na(tss)], aes(dist_to_zcwCVC, dist_to_h3k4me3)) + geom_point(stroke=0, alpha=0.2, size=0.6) + xlim(-500,500) + ylim(-500,500)

#ggplot(HP9combo_peaks[FC_h3k4me3_UT_enrichment<1], aes(dist_to_zcwCVC, dist_to_h3k4me3)) + geom_point(stroke=0, alpha=0.2, size=0.6) + xlim(-500,500) + ylim(-500,500)

ggplot(HP9combo_peaks, aes(dist_to_zcwCVC, dist_to_h3k4me3)) + geom_point(stroke=0, alpha=0.2, size=0.6) + xlim(-500,500) + facet_wrap(~!is.na(tss)) + ylim(-500,500)

ggplot(HP9combo_peaks, aes(dist_to_zcwCVC, dist_to_h3k36me3)) + geom_point(stroke=0, alpha=0.2, size=0.6) + xlim(-500,500) + ylim(-500,500)
```


```{r dist_to}
HP9combo_peaks$DMC1_enrichment <- foverlaps(HP9combo_peaks, dmc1, mult="first")$enrichment

HP9combo_peaks$isDMC1 <- !is.na(HP9combo_peaks$DMC1_enrichment)

cor(HP9combo_peaks[isDMC1==T]$dist_to_zcwCVC, HP9combo_peaks[isDMC1==T]$dist_to_h3k4me3, use="complete.obs")
cor(HP9combo_peaks[isDMC1==F]$dist_to_zcwCVC, HP9combo_peaks[isDMC1==F]$dist_to_h3k4me3, use="complete.obs")
ggplot(HP9combo_peaks, aes(dist_to_zcwCVC, dist_to_h3k4me3)) + geom_point(stroke=0, alpha=0.2, size=1.5) + xlim(-500,500) + ylim(-500,500) + facet_wrap(~isDMC1)


fraction_overlap_mean <- function(dt,x,y,n=30, returndf=F){
  setorder(dt, dist_to_zcwCVC)
  
  dt$enrichment_bin <- cut(1:nrow(dt), n)
  
  tmp <- dt[,.(mean=mean(get(x)),
               num=.N,
               dist=mean(get(y)),
               sem=sd((get(y)))/sqrt(length(get(y))),
            sem_mean=sd((get(x)))/sqrt(length(get(x)))),
               by=enrichment_bin]
  
  if(returndf){
    return(tmp)
  }else{
  return(
  ggplot(tmp, aes(mean, dist)) +
    geom_pointrange(aes(ymax = dist + 2*sem, ymin = dist - 2*sem)) +
    geom_errorbarh(aes(xmax= mean + 2*sem_mean, xmin = mean - 2*sem_mean), colour='red') +
    ylab(paste("Mean",y)) + xlab("Binned")
  )
  }
}

fraction_overlap_mean(HP9combo_peaks[isDMC1==T], "dist_to_zcwCVC", "dist_to_h3k4me3")
fraction_overlap_mean(HP9combo_peaks[isDMC1==F], "dist_to_zcwCVC", "dist_to_h3k4me3")

fraction_overlap_mean(HP9combo_peaks[!is.na(dist_to_zcwCVC) & !is.na(dist_to_h3k4me3)], "dist_to_zcwCVC", "dist_to_h3k4me3")

# horizontal bars are small
# fraction_overlap_mean(HP9combo_peaks[!is.na(dist_to_zcwCVC) & !is.na(dist_to_h3k4me3)], "dist_to_zcwCVC", "dist_to_h3k4me3", n=30) + xlim(-3,-1)
# fraction_overlap_mean(HP9combo_peaks[!is.na(dist_to_zcwCVC) & !is.na(dist_to_h3k4me3)], "dist_to_zcwCVC", "dist_to_h3k4me3", n=30, returndf = T)
```



# Sandbox



```{r sandbox, eval=FALSE}
nearest_peak <- function(x, A=zcw_wP9_peaks, B=h3k4me3_P9_peaks) min(abs(A[chr=="chr16" & center_start<3.1e+07][x]$center_start - B[chr=="chr16"]$center_start))

set.seed(42)
uniform_dist <- sample(1:max(zcw_wP9_peaks[chr=="chr16" & center_start<3.1e+07]$center_start), 10000)

no <- sort(uniform_dist)[diff(sort(uniform_dist))<250]
uniform_dist <- uniform_dist[!uniform_dist %in% no][1:5000]

nearest_peak_null <- function(x, B=h3k4me3_P9_peaks) min(abs(uniform_dist[x] - B[chr=="chr16"]$center_start))

plot_cum_nearest <- function(nearest, nearest_null, to=10e4, by=100){
  cum_nearest <- function(x, vec=nearest) sum(vec<x)/length(vec)
  dt <- data.table(dist=seq(1,to,by),
             overlap=sapply(seq(1,to,by), cum_nearest),
             overlap_null=sapply(seq(1,to,by), function(x) cum_nearest(x, vec=nearest_null)))
  ggplot(dt, aes(dist, overlap)) +
    geom_line() +
      xlab("Distance to peak") + ylab("Cumulative fraction of peaks") + 
    geom_line(aes(y=overlap_null), colour='red')
}

set.seed(42)
indexes <- sample(1:nrow(zcw_wP9_peaks[chr=="chr16" & center_start<3.1e+07]), 5000)

nearest <- sapply(indexes, nearest_peak)
nearest_null <- sapply(seq_along(uniform_dist), nearest_peak_null)


nearest_k36 <- sapply(indexes, function(x) nearest_peak(x, B=h3k36me3_P9_peaks))
nearest_null_k36 <- sapply(seq_along(uniform_dist), function(x) nearest_peak_null(x, B=h3k36me3_P9_peaks))

nearest_hP9 <- sapply(indexes, function(x) nearest_peak(x, B=HP9_peaks))
nearest_null_hP9 <- sapply(seq_along(uniform_dist), function(x) nearest_peak_null(x, B=HP9_peaks))



plot_cum_nearest(nearest, nearest_null, to=1e4)
plot_cum_nearest(nearest_k36, nearest_null_k36, to=1e4)
plot_cum_nearest(nearest_hP9, nearest_null_hP9, to=1e4)

# debugging plot
# plot(sort(uniform_dist)[100:140], rep(1,41), col='blue')
# points(zcw_wP9_peaks[chr=="chr16"]$center_start[indexes], rep(0.98,length(indexes)))
# points(h3k4me3_P9_peaks[chr=="chr16"]$center_start, rep(0.96,nrow(h3k4me3_P9_peaks[chr=="chr16"])), col='red')


hist(nearest, breaks=10000, xlim=c(0,10000), ylim=c(0,100))
hist(nearest_null, breaks=10000, xlim=c(0,10000), ylim=c(0,100))

hist(nearest_k36, breaks=10000, xlim=c(0,10000), ylim=c(0,100))
hist(nearest_null_k36, breaks=10000, xlim=c(0,10000), ylim=c(0,100))

```



```{r simons, eval=FALSE}
 hist(Zcw_CVC_AT_hP9$pvalue[Zcw_CVC_AT_hP9$cov_input>=30 & HP9_peaks$enrichment>=10 & HP9_peaks$cov_input>=5],n=100)
aa=Zcw_CVC_AT_hP9$cov_r1+Zcw_CVC_AT_hP9$cov_r2
bb=Zcw_CVC_AT_hP9$cov_input
cc=Zcw_CVC_AT_hP9$enrichment
dd=cc*bb
summary(lm(dd~aa+bb))

enrich*bg=(0.5*(cov1+cov2)-0.3552*bg)
> summary(lm(dd~0+aa+bb))

enrich*bg=(0.5*(cov1+cov2)-0.3525*bg)
> predcc=(0.5*aa-0.325*bb)/bb
> plot(predcc,cc)
> summary(lm(dd[dd>0]~0+aa[dd>0]+bb[dd>0]))

predcc=(0.5*aa-0.3555*bb)/bb
> summary(lm(dd[dd>0]~aa[dd>0]+bb[dd>0]))

plot(predcc,cc)
abline(0,1)
cc2=HP9_peaks$enrichment
bb2=HP9_peaks$cov_input
plot(cc2[bb>=5 & bb2>=5],aa[bb>=5 & bb2>=5],pch=".",ylim=c(0.1,200),log="xy")
plot(cc2[bb>=5 & bb2>=5],cc[bb>=5 & bb2>=5],pch=".",ylim=c(0.01,5),log="xy")
mean(cc[bb>=5 & bb2>=5 & cc2>5])
ee=aa-0.355*bb
mean(aa[bb>=5 & bb2>=5 & cc2>2])
hist(Zcw_CVC_AT_hP9$pvalue[Zcw_CVC_AT_hP9$cov_input>=5 & HP9_peaks$enrichment>=5 & HP9_peaks$cov_input>=5],n=100)
mean(Zcw_CVC_AT_hP9$pvalue[HP9_peaks$enrichment>=10 & HP9_peaks$cov_input>=5]<=1e-6)



```

